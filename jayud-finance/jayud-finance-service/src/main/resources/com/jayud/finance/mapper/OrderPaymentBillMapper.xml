<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jayud.finance.mapper.OrderPaymentBillMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.jayud.finance.po.OrderPaymentBill">
        <id column="id" property="id" />
        <result column="bill_no" property="billNo" />
        <result column="begin_account_term" property="beginAccountTerm" />
        <result column="end_account_term" property="endAccountTerm" />
        <result column="settlement_currency" property="settlementCurrency" />
        <result column="legal_name" property="legalName" />
        <result column="customer_name" property="customerName" />
        <result column="audit_status" property="auditStatus" />
        <result column="make_user" property="makeUser" />
        <result column="make_time" property="makeTime" />
        <result column="audit_user" property="auditUser" />
        <result column="audit_time" property="auditTime" />
        <result column="apply_status" property="applyStatus" />
        <result column="payment_amount" property="paymentAmount" />
        <result column="already_paid_amount" property="alreadyPaidAmount" />
        <result column="bill_order_num" property="billOrderNum" />
        <result column="bill_num" property="billNum" />
        <result column="created_user" property="createdUser" />
        <result column="created_time" property="createdTime" />
        <result column="updated_user" property="updatedUser" />
        <result column="updated_time" property="updatedTime" />
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id, bill_no, begin_account_term, end_account_term, settlement_currency, legal_name, customer_name, audit_status, make_user, make_time, audit_user, audit_time, apply_status, payment_amount,
        already_paid_amount,bill_order_num, bill_num, created_user, created_time, updated_user, updated_time
    </sql>

    <select id="findPaymentBillByPage" parameterType="com.jayud.finance.bo.QueryPaymentBillForm" resultType="com.jayud.finance.vo.OrderPaymentBillVO" >
        SELECT DISTINCT
            oi.legal_name legalName,
            oi.customer_name customerName,
            opb.already_paid_amount alreadyPaidAmount,
            ifnull( opb.bill_order_num, 0 ) billOrderNum,
            ifnull( opb.bill_num, 0 ) billNum,
            (
            SELECT
                SUM( opc.change_amount )
            FROM
                order_payment_cost opc
            WHERE
                opc.order_no IN ( SELECT a.order_no FROM order_info a WHERE a.legal_name = oi.legal_name AND a.customer_name = oi.customer_name )
                AND opc.is_bill = '0'
            ) notPaidAmount,
            (
            SELECT
                count( DISTINCT opc.order_no )
            FROM
                order_payment_cost opc
            WHERE
                opc.order_no IN ( SELECT a.order_no FROM order_info a WHERE a.legal_name = oi.legal_name AND a.customer_name = oi.customer_name )
                AND opc.is_bill = '0'
            ) notPaidOrderNum
        FROM
            order_info oi
            LEFT JOIN order_payment_bill opb ON opb.legal_name = oi.legal_name
            AND opb.customer_name = oi.customer_name
    </select>
</mapper>
