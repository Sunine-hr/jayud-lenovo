<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jayud.finance.mapper.OrderReceivableBillMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.jayud.finance.po.OrderReceivableBill">
        <id column="id" property="id"/>
        <result column="legal_name" property="legalName"/>
        <result column="unit_account" property="unitAccount"/>
        <result column="already_paid_amount" property="alreadyPaidAmount"/>
        <result column="bill_order_num" property="billOrderNum"/>
        <result column="bill_num" property="billNum"/>
        <result column="sub_type" property="subType"/>
        <result column="is_main" property="isMain"/>
        <result column="created_user" property="createdUser"/>
        <result column="created_time" property="createdTime"/>
        <result column="updated_user" property="updatedUser"/>
        <result column="updated_time" property="updatedTime"/>
    </resultMap>

    <sql id="TmsInfo">
            (SELECT GROUP_CONCAT(ota.goods_desc) FROM order_take_adr ota WHERE ota.order_no = sub.order_no AND ota.opr_type = '1' GROUP BY sub.order_no) goodsDesc,
            (SELECT GROUP_CONCAT(concat( ifnull(da.city_name,''), da.address )) FROM delivery_address da LEFT JOIN order_take_adr ota ON da.id = ota.delivery_id
            WHERE ota.order_no = sub.order_no AND ota.opr_type = '1' GROUP BY sub.order_no) startAddress,
            (SELECT GROUP_CONCAT(concat( ifnull(da.city_name,''), da.address )) FROM delivery_address da LEFT JOIN order_take_adr ota ON da.id = ota.delivery_id
            WHERE ota.order_no = sub.order_no AND ota.opr_type = '2' GROUP BY sub.order_no) endAddress,
            sub.vehicle_size vehicleSize,
            (select sum(ota.plate_amount) from order_take_adr ota where ota.order_no = sub.order_no) pieceNum,
            (select sum(ota.weight) from order_take_adr ota where ota.order_no = sub.order_no)	weight,
            concat( vi.plate_number,',', vi.hk_number ) licensePlate,
        </sql>

    <sql id="GoodsAndOrderAddress">
    	    (SELECT GROUP_CONCAT(g.name SEPARATOR ',') FROM goods g WHERE g.business_id = sub.id AND g.order_no = sub.order_no GROUP BY g.business_id,g.business_type) goodsDesc,
            (SELECT GROUP_CONCAT(addr.address SEPARATOR ',') FROM order_address addr WHERE addr.business_id = sub.id AND addr.order_no = sub.order_no and (addr.type=0 or addr.type=3) GROUP BY addr.business_id,addr.business_type) startAddress,
            (SELECT GROUP_CONCAT(addr.address SEPARATOR ',') FROM order_address addr WHERE addr.business_id = sub.id AND addr.order_no = sub.order_no and (addr.type=1 or addr.type=4) GROUP BY addr.business_id,addr.business_type) endAddress,
        </sql>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id, legal_name, unit_account, already_paid_amount, bill_order_num, bill_num, sub_type, is_main, created_user, created_time, updated_user, updated_time
    </sql>

    <select id="findReceiveBillNum" parameterType="com.jayud.finance.bo.QueryReceiveBillNumForm"
            resultType="com.jayud.finance.vo.OrderPaymentBillNumVO">
        SELECT
        ob.bill_no billNo,
        ob.account_term accountTermStr,
        ( SELECT count( DISTINCT orbd.order_no ) FROM order_receivable_bill_detail orbd WHERE ob.bill_no = orbd.bill_no
        ) billNum,
        (select ifnull(sum(obct.local_money),0) from order_bill_cost_total obct where obct.cost_id = ob.cost_id and
        obct.money_type=2 )
        localAmount,
        (select ifnull(sum(cav.real_receive_money),0) from cancel_after_verification cav where cav.bill_no = ob.bill_no)
        heXiaoAmount,
        ob.audit_status billStatus,
        ob.make_user makeUser,
        DATE_FORMAT(ob.make_time,'%Y-%m-%d %H:%i:%S') makeTimeStr
        FROM
        order_receivable_bill_detail ob left join order_receivable_bill orb on ob.bill_id = orb.id
        where orb.legal_name = #{form.legalName} and orb.unit_account = #{form.unitAccount}
        <choose>
            <when test="form.cmd == 'main'">
                and orb.is_main = 1
            </when>
            <otherwise>
                -- TODO 2021-01-20 修改的不知道会不影响之前传梅版本财务
                <if test="form.cmd != null and form.cmd !=''">
                    and orb.is_main = 0 and orb.sub_type = #{form.cmd}
                </if>
            </otherwise>
        </choose>
        group by bill_no
        <!--        <if test="form.cmd == 'zgys'">-->
        <!--            and orb.is_main = 0 and orb.sub_type = 'zgys'-->
        <!--        </if>-->
        <!--        <if test="form.cmd == 'bg'">-->
        <!--            and orb.is_main = 0 and orb.sub_type = 'bg'-->
        <!--        </if>-->
        <!--        <if test="form.cmd == 'ky'">-->
        <!--            and orb.is_main = 0 and orb.sub_type = 'ky'-->
        <!--        </if>-->
    </select>
    <select id="findNotPaidBillByPage" parameterType="com.jayud.finance.bo.QueryNotPaidBillForm"
            resultType="com.jayud.finance.vo.ReceiveNotPaidBillVO">
        select * from (
        SELECT DISTINCT
        orc.main_order_no orderNo,
        orc.order_no subOrderNo,
        pb.`name` bizCodeDesc,
        oi.created_user createdUser,
        DATE_FORMAT( oi.create_time, '%Y-%m-%d' ) createdTimeStr,
        c.`name` unitAccount,
        <choose>
            <when test="form.cmd == 'zgys'">
                <include refid="TmsInfo"/>
            </when>
        </choose>
        cg.`name` costGenreName,
        ct.code_name costTypeName,
        ci.`name` costName,
        orc.amount,
        orc.currency_code,
        orc.change_amount localAmount,
        orc.id costId,
        orc.is_bill isBill,
        oi.operation_time,
        oi.biz_code bizCode,oi.biz_belong_depart,orc.is_internal
        FROM
        order_receivable_cost orc
        LEFT JOIN order_info oi ON orc.main_order_no = oi.order_no
        left join customer_info c on c.id_code = orc.customer_code
        LEFT JOIN product_biz pb ON pb.id_code = oi.biz_code
        LEFT JOIN cost_genre cg ON orc.cost_genre_id = cg.id
        LEFT JOIN cost_type ct ON orc.cost_type_id = ct.id
        LEFT JOIN cost_info ci ON orc.cost_code = ci.id_code
        <if test="dynamicSqlParam.table !=null and dynamicSqlParam.table != ''">
            <choose>
                <when test="form.cmd == 'zgys'">
                    LEFT JOIN order_transport sub ON sub.main_order_no = oi.order_no
                    LEFT JOIN order_send_cars osc ON sub.order_no = osc.order_no
                    left join order_customs oc on oc.order_no = orc.order_no
                    left join vehicle_info vi on vi.id = osc.vehicle_id
                </when>
                <when test="form.cmd == 'cce' or form.cmd == 'cci' or form.cmd == 'ccf'">

                </when>
                <otherwise>
                    left join ${dynamicSqlParam.table} sub on sub.order_no = orc.order_no
                </otherwise>
            </choose>
        </if>
        -- left join air_order ao on ao.order_no = orc.order_no
        -- left join sea_order so on so.order_no = orc.order_no
        -- left join order_inland_transport oit on oit.order_no = orc.order_no
        -- left join trailer_order tor on tor.order_no = orc.order_no
        -- left join storage_input_order sio on sio.order_no = orc.order_no
        -- left join storage_out_order soo on soo.order_no = orc.order_no
        WHERE
        orc.id NOT IN ( SELECT orbd.cost_id FROM order_receivable_bill_detail orbd where orbd.audit_status!='edit_del')
        and (orc.is_bill != '2' and orc.is_bill!='save_confirm')
        and orc.`status` = '3'
        and c.`name` = #{form.unitAccount}
        <if test="form.cmd == 'main'">
            and oi.legal_name = #{form.legalName}
            and orc.is_sum_to_main = 1
        </if>
        <if test="dynamicSqlParam.table !=null and dynamicSqlParam.table != ''">
            <choose>
                <when test="form.cmd == 'cce' or form.cmd == 'cci' or form.cmd == 'ccf'">
                    and orc.legal_name = #{form.legalName}
                    and orc.is_sum_to_main = 0 and orc.sub_type = #{form.cmd}
                </when>
                <otherwise>
                    and sub.legal_name = #{form.legalName}
                    and orc.is_sum_to_main = 0 and orc.sub_type = #{form.cmd}
                </otherwise>
            </choose>
        </if>

        <!--        <if test="form.cmd == 'zgys'">-->
        <!--            and ot.legal_name = #{form.legalName}-->
        <!--            and orc.is_sum_to_main = 0 and orc.sub_type = 'zgys'-->
        <!--        </if>-->
        <!--        <if test="form.cmd == 'bg'">-->
        <!--            and oc.legal_name = #{form.legalName}-->
        <!--            and orc.is_sum_to_main = 0 and orc.sub_type = 'bg'-->
        <!--        </if>-->
        <!--        <if test="form.cmd == 'ky'">-->
        <!--            and ao.legal_name = #{form.legalName}-->
        <!--            and orc.is_sum_to_main = 0 and orc.sub_type = 'ky'-->
        <!--        </if>-->
        <!--        <if test="form.cmd == 'hy'">-->
        <!--            and so.legal_name = #{form.legalName}-->
        <!--            and orc.is_sum_to_main = 0 and orc.sub_type = 'hy'-->
        <!--        </if>-->
        <!--        <if test="form.cmd == 'tc'">-->
        <!--            and tor.legal_name = #{form.legalName}-->
        <!--            and orc.is_sum_to_main = 0 and orc.sub_type = 'tc'-->
        <!--        </if>-->
        <!--        <if test="form.cmd == 'nl'">-->
        <!--            and oit.legal_name = #{form.legalName}-->
        <!--            and orc.is_sum_to_main = 0 and orc.sub_type = 'nl'-->
        <!--        </if>-->
        <!--        <if test="form.cmd == 'cci'">-->
        <!--            and orc.legal_name = #{form.legalName}-->
        <!--            and orc.is_sum_to_main = 0 and orc.sub_type = 'cci'-->
        <!--        </if>-->
        <!--        <if test="form.cmd == 'cce'">-->
        <!--            and orc.legal_name = #{form.legalName}-->
        <!--            and orc.is_sum_to_main = 0 and orc.sub_type = 'cce'-->
        <!--        </if>-->
        ) temp where 1 = 1
        <if test="form.orderNo != null and form.orderNo != ''">
            and temp.orderNo like concat('%',#{form.orderNo},'%')
        </if>
        <if test="form.startAddress != null and form.startAddress != ''">
            and temp.startAddress like concat('%',#{form.startAddress},'%')
        </if>
        <if test="form.endAddress != null and form.endAddress != ''">
            and temp.endAddress like concat('%',#{form.endAddress},'%')
        </if>
        <if test="form.costName != null and form.costName != ''">
            and temp.costName like concat('%',#{form.costName},'%')
        </if>
        <if test="form.currencyCode !=null and form.currencyCode !=''">
            and temp.currency_code = #{form.currencyCode}
        </if>
        <if test="form.userName !=null and form.userName !=''">
            and temp.createdUser =#{form.userName}
        </if>
        <!--        <if test="form.currencyCode == 'CNY'">-->
        <!--            and temp.rmb is not null-->
        <!--        </if>-->
        <!--        <if test="form.currencyCode == 'USD'">-->
        <!--            and temp.dollar is not null-->
        <!--        </if>-->
        <!--        <if test="form.currencyCode == 'HKD'">-->
        <!--            and temp.hKDollar is not null-->
        <!--        </if>-->
        <!--        <if test="form.currencyCode == 'EUR'">-->
        <!--            and temp.euro is not null-->
        <!--        </if>-->
        <if test="form.endCreatedTimeStr != null and form.endCreatedTimeStr !=''">
            and date_format(temp.createdTimeStr,'%Y-%m-%d') &lt;= date_format(#{form.endCreatedTimeStr},'%Y-%m-%d')
        </if>
        <if test="form.beginCreatedTimeStr != null and form.beginCreatedTimeStr !=''">
            and date_format(temp.createdTimeStr,'%Y-%m-%d') >= date_format(#{form.beginCreatedTimeStr},'%Y-%m-%d')
        </if>
        <if test="form.operationTime != null and form.operationTime.size>0">
            and date_format(temp.operation_time,'%Y-%m-%d')
            BETWEEN #{form.operationTime[0]} AND #{form.operationTime[1]}
        </if>
        <if test="form.bizCode != null and form.bizCode!=''">
            and temp.bizCode =#{form.bizCode}
        </if>
        <if test="form.departmentId != null">
            and temp.biz_belong_depart =#{form.departmentId}
        </if>
    </select>


    <select id="findNotPaidOrderBillByPage" parameterType="com.jayud.finance.bo.QueryNotPaidBillForm"
            resultType="com.jayud.finance.vo.ReceiveNotPaidBillVO">
        select * from (
        SELECT DISTINCT
        orc.main_order_no orderNo,
        orc.order_no subOrderNo,
        pb.`name` bizCodeDesc,
        oi.operation_time,
        oi.created_user createdUser,
        -- orc.is_bill,
        DATE_FORMAT( oi.create_time, '%Y-%m-%d' ) createdTimeStr,
        oi.biz_code bizCode,
        orc.legal_id,
        orc.customer_code
        FROM
        order_receivable_cost orc
        LEFT JOIN order_info oi ON orc.main_order_no = oi.order_no
        left join customer_info c on c.id_code = orc.customer_code
        LEFT JOIN product_biz pb ON pb.id_code = oi.biz_code
        <choose>
            <when test="form.cmd == 'cce' or form.cmd == 'cci' or form.cmd == 'ccf'">

            </when>
            <when test="dynamicSqlParam.table !=null and dynamicSqlParam.table != ''">
                left join ${dynamicSqlParam.table} sub on sub.order_no = orc.order_no
            </when>
        </choose>

        WHERE
        orc.id NOT IN ( SELECT orbd.cost_id FROM order_receivable_bill_detail orbd where orbd.audit_status!='edit_del')
        and (orc.is_bill != '2' and orc.is_bill!='save_confirm')
        and orc.`status` = '3'
        and c.`name` = #{form.unitAccount}
        <if test="form.cmd == 'main'">
            and oi.legal_name = #{form.legalName}
            and orc.is_sum_to_main = 1
        </if>
        <if test="dynamicSqlParam.table !=null and dynamicSqlParam.table != ''">
            <choose>
                <when test="form.cmd == 'cce' or form.cmd == 'cci' or form.cmd == 'ccf'">
                    and orc.legal_name = #{form.legalName}
                    and orc.is_sum_to_main = 0 and orc.sub_type = #{form.cmd}
                </when>
                <otherwise>
                    and sub.legal_name = #{form.legalName}
                    and orc.is_sum_to_main = 0 and orc.sub_type = #{form.cmd}
                </otherwise>
            </choose>
        </if>
        ) temp where 1 = 1
        <if test="form.orderNo != null and form.orderNo != ''">
            and temp.orderNo like concat('%',#{form.orderNo},'%')
        </if>
        <if test="form.endCreatedTimeStr != null and form.endCreatedTimeStr !=''">
            and date_format(temp.createdTimeStr,'%Y-%m-%d') &lt;= date_format(#{form.endCreatedTimeStr},'%Y-%m-%d')
        </if>
        <if test="form.beginCreatedTimeStr != null and form.beginCreatedTimeStr !=''">
            and date_format(temp.createdTimeStr,'%Y-%m-%d') >= date_format(#{form.beginCreatedTimeStr},'%Y-%m-%d')
        </if>
        <if test="form.userName !=null and form.userName !=''">
            and temp.createdUser =#{form.userName}
        </if>
        <if test="form.operationTime != null and form.operationTime.size>0">
            and date_format(temp.operation_time,'%Y-%m-%d')
            BETWEEN #{form.operationTime[0]} AND #{form.operationTime[1]}
        </if>
        <if test="form.bizCode != null and form.bizCode!=''">
            and temp.bizCode =#{form.bizCode}
        </if>
        <choose>
            <when test="form.cmd == 'main'">
                group by temp.orderNo
            </when>
            <otherwise>
                group by temp.orderNo,temp.subOrderNo
            </otherwise>
        </choose>

    </select>

    <select id="findBaseNotPaidBillByPage" parameterType="com.jayud.finance.bo.QueryNotPaidBillForm"
            resultType="com.jayud.finance.vo.ReceiveNotPaidBillVO">
        select * from (
        SELECT DISTINCT
        orc.main_order_no orderNo,
        orc.order_no subOrderNo,
        pb.`name` bizCodeDesc,
        DATE_FORMAT( oi.create_time, '%Y-%m-%d' ) createdTimeStr,
        c.`name` unitAccount,
        <choose>
            <when test="form.cmd == 'zgys'">
                <include refid="TmsInfo"/>
            </when>
            <when test="form.isQueryOrderAddress">
                <include refid="GoodsAndOrderAddress"/>
            </when>
        </choose>
        ( SELECT GROUP_CONCAT( oc.yun_customs_no SEPARATOR ',' ) FROM order_customs oc WHERE oc.main_order_no =
        oi.order_no ) yunCustomsNo,
        cg.`name` costGenreName,
        ct.code_name costTypeName,
        ci.`name` costName,
        (SELECT sum(rmb.amount) FROM order_receivable_cost rmb WHERE rmb.id = orc.id AND rmb.currency_code = 'CNY' GROUP
        BY
        rmb.cost_code,rmb.cost_genre_id,rmb.cost_type_id) rmb,
        (SELECT sum(rmb.amount) FROM order_receivable_cost rmb WHERE rmb.id = orc.id AND rmb.currency_code = 'USD' GROUP
        BY
        rmb.cost_code,rmb.cost_genre_id,rmb.cost_type_id) dollar,
        (SELECT sum(rmb.amount) FROM order_receivable_cost rmb WHERE rmb.id = orc.id AND rmb.currency_code = 'EUR' GROUP
        BY
        rmb.cost_code,rmb.cost_genre_id,rmb.cost_type_id) euro,
        (SELECT sum(rmb.amount) FROM order_receivable_cost rmb WHERE rmb.id = orc.id AND rmb.currency_code = 'HKD' GROUP
        BY
        rmb.cost_code,rmb.cost_genre_id,rmb.cost_type_id) hKDollar,
        (SELECT sum(rmb.change_amount) FROM order_receivable_cost rmb WHERE rmb.id = orc.id GROUP BY
        rmb.cost_code,rmb.cost_genre_id,rmb.cost_type_id) localAmount,
        orc.id costId,
        orc.is_bill isBill
        FROM
        order_receivable_cost orc
        LEFT JOIN order_info oi ON orc.main_order_no = oi.order_no
        left join customer_info c on c.id_code = orc.customer_code
        LEFT JOIN product_biz pb ON pb.id_code = oi.biz_code
        LEFT JOIN cost_genre cg ON orc.cost_genre_id = cg.id
        LEFT JOIN cost_type ct ON orc.cost_type_id = ct.id
        LEFT JOIN cost_info ci ON orc.cost_code = ci.id_code

        <choose>
            <when test="form.cmd == 'cci' or form.cmd == 'cce' or form.cmd == 'ccf'">
                <if test="dynamicSqlParam.table !=null and dynamicSqlParam.table != ''">
                    left join order_payment_cost sub on sub.legal_id = opc.legal_id
                    <!--            <if test="form.cmd == 'zgys'">-->
                    <!--                &#45;&#45; TODO 扩展连接-->

                    <!--            </if>-->
                </if>
            </when>
            <otherwise>
                <if test="dynamicSqlParam.table !=null and dynamicSqlParam.table != ''">
                    left join ${dynamicSqlParam.table} sub on sub.order_no = opc.order_no
                    <!--            <if test="form.cmd == 'zgys'">-->
                    <!--                &#45;&#45; TODO 扩展连接-->

                    <!--            </if>-->
                </if>
            </otherwise>
        </choose>

        <!--        <if test="dynamicSqlParam.table !=null and dynamicSqlParam.table != ''">-->
        <!--            left join ${dynamicSqlParam.table} sub on sub.order_no = orc.order_no-->
        <!--            &lt;!&ndash;            <if test="form.cmd == 'zgys'">&ndash;&gt;-->
        <!--            &lt;!&ndash;                &#45;&#45; TODO 扩展连接&ndash;&gt;-->

        <!--            &lt;!&ndash;            </if>&ndash;&gt;-->
        <!--        </if>-->


        -- LEFT JOIN order_transport ot ON ot.main_order_no = oi.order_no
        -- LEFT JOIN order_send_cars osc ON ot.order_no = osc.order_no
        -- left join order_customs oc on oc.order_no = orc.order_no
        -- left join air_order ao on ao.order_no = orc.order_no
        -- left join sea_order so on so.order_no = orc.order_no
        WHERE
        orc.id NOT IN ( SELECT orbd.cost_id FROM order_receivable_bill_detail orbd where orbd.audit_status!='edit_del')
        and (orc.is_bill != '2' and orc.is_bill!='save_confirm')
        and orc.`status` = '3'
        and c.`name` = #{form.unitAccount}

        <choose>
            <when test="form.cmd == 'main'">
                and oi.legal_name = #{form.legalName}
                and orc.is_sum_to_main = 1
            </when>
            <when test="form.cmd == 'cci' or form.cmd == 'cce' or form.cmd == 'ccf'">
                and sub.legal_name = #{form.legalName}
                and orc.is_sum_to_main = 0 and orc.sub_type = #{form.cmd}
            </when>
            <when test="form !=null and form.cmd !=''">
                and sub.legal_name = #{form.legalName}
                and orc.is_sum_to_main = 0 and orc.sub_type = #{form.cmd}
            </when>
        </choose>

        <!--        <if test="form.cmd == 'zgys'">-->
        <!--            and ot.legal_name = #{form.legalName}-->
        <!--            and orc.is_sum_to_main = 0 and orc.sub_type = 'zgys'-->
        <!--        </if>-->
        <!--        <if test="form.cmd == 'bg'">-->
        <!--            and oc.legal_name = #{form.legalName}-->
        <!--            and orc.is_sum_to_main = 0 and orc.sub_type = 'bg'-->
        <!--        </if>-->
        <!--        <if test="form.cmd == 'ky'">-->
        <!--            and ao.legal_name = #{form.legalName}-->
        <!--            and orc.is_sum_to_main = 0 and orc.sub_type = 'ky'-->
        <!--        </if>-->
        <!--        <if test="form.cmd == 'hy'">-->
        <!--            and so.legal_name = #{form.legalName}-->
        <!--            and orc.is_sum_to_main = 0 and orc.sub_type = 'hy'-->
        <!--        </if>-->
        ) temp where 1 = 1
        <if test="form.startAddress != null and form.startAddress != ''">
            and temp.startAddress like concat('%',#{form.startAddress},'%')
        </if>
        <if test="form.endAddress != null and form.endAddress != ''">
            and temp.endAddress like concat('%',#{form.endAddress},'%')
        </if>
        <if test="form.costName != null and form.costName != ''">
            and temp.costName like concat('%',#{form.costName},'%')
        </if>
        <if test="form.currencyCode == 'CNY'">
            and temp.rmb is not null
        </if>
        <if test="form.currencyCode == 'USD'">
            and temp.dollar is not null
        </if>
        <if test="form.currencyCode == 'HKD'">
            and temp.hKDollar is not null
        </if>
        <if test="form.currencyCode == 'EUR'">
            and temp.euro is not null
        </if>
        <if test="form.endCreatedTimeStr != null and form.endCreatedTimeStr !=''">
            and date_format(temp.createdTimeStr,'%Y-%m-%d') &lt;= date_format(#{form.endCreatedTimeStr},'%Y-%m-%d')
        </if>
        <if test="form.beginCreatedTimeStr != null and form.beginCreatedTimeStr !=''">
            and date_format(temp.createdTimeStr,'%Y-%m-%d') >= date_format(#{form.beginCreatedTimeStr},'%Y-%m-%d')
        </if>
    </select>


    <select id="getSBillOrderNum" resultType="java.lang.Integer">
      SELECT
	    count( DISTINCT orbd.order_no ) billOrderNum
      FROM
	    order_receivable_bill_detail orbd
	    LEFT JOIN order_receivable_bill orb ON orbd.bill_id = orb.id
      WHERE
        orb.legal_name = #{legalName}
        AND orb.unit_account = #{unitAccount}
        AND orb.sub_type = #{subType}
    </select>

    <!-- TODO 修改为根据法人id和结算code-->
    <select id="getSBillOrderNumByLegalId" resultType="java.lang.Integer">
      SELECT
	    count( DISTINCT orbd.order_no ) billOrderNum
      FROM
	    order_receivable_bill_detail orbd
	    LEFT JOIN order_receivable_bill orb ON orbd.bill_id = orb.id
      WHERE
        orb.legal_entity_id = #{legalId}
        AND orb.unit_code = #{unitCode}
        AND orb.sub_type = #{subType}
    </select>


    <!--TODO 1.1 历史BUG根据法人名称和结算名称查询-->
    <select id="getSAlreadyPaidAmount" resultType="java.math.BigDecimal">
      SELECT
	    ifnull(sum(orbd.local_amount),0) billOrderNum
      FROM
	    order_receivable_bill_detail orbd
	    LEFT JOIN order_receivable_bill orb ON orbd.bill_id = orb.id
      WHERE
        orb.legal_name = #{legalName}
        AND orb.unit_account = #{unitAccount}
        AND orb.sub_type = #{subType}
        AND orbd.audit_status!='edit_del'
    </select>

    <!-- TODO 1.1 修改后根据法人主体id和结算code-->
    <select id="getSAlreadyPaidAmountByLegalId" resultType="java.math.BigDecimal">
      SELECT
	    ifnull(sum(orbd.local_amount),0) billOrderNum
      FROM
	    order_receivable_bill_detail orbd
	    LEFT JOIN order_receivable_bill orb ON orbd.bill_id = orb.id
      WHERE
        orb.legal_entity_id = #{legalId}
        AND orb.unit_code = #{unitCode}
        AND orb.sub_type = #{subType}
        AND orbd.audit_status!='edit_del'
    </select>


    <select id="getSBillNum" resultType="java.lang.Integer">
      SELECT
	    count( DISTINCT orbd.bill_no ) billOrderNum
      FROM
	    order_receivable_bill_detail orbd
	    LEFT JOIN order_receivable_bill orb ON orbd.bill_id = orb.id
      WHERE
        orb.legal_name = #{legalName}
        AND orb.unit_account = #{unitAccount}
        AND orb.sub_type = #{subType}
    </select>
    <!--TODO 修改成根据法人id和结算code-->
    <select id="getSBillNumByLegalId" resultType="java.lang.Integer">
      SELECT
	    count( DISTINCT orbd.bill_no ) billOrderNum
      FROM
	    order_receivable_bill_detail orbd
	    LEFT JOIN order_receivable_bill orb ON orbd.bill_id = orb.id
      WHERE
         orb.legal_entity_id = #{legalId}
        AND orb.unit_code = #{unitCode}
        AND orb.sub_type = #{subType}
    </select>


    <select id="findSheetHead" parameterType="java.util.List" resultType="com.jayud.finance.vo.SheetHeadVO">
        SELECT
        CONCAT( orc.cost_code, orc.currency_code ) NAME,
        concat((select ci.name from cost_info ci where ci.id_code = orc.cost_code),'(',(select ci.currency_name from
        currency_info ci where ci. currency_code = orc.currency_code),')') viewName,
        sum( orc.amount )
        FROM
        order_receivable_cost orc
        WHERE
        orc.id IN
        <foreach collection="costIds" index="index" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
        GROUP BY
        orc.cost_code,
        orc.currency_code

        union

        SELECT
        concat('T',orc.currency_code) NAME,
        concat('合计(',(select ci.currency_name from currency_info ci where ci. currency_code = orc.currency_code),')')
        viewName,
        sum( orc.amount )
        FROM
        order_receivable_cost orc
        WHERE
        orc.id IN
        <foreach collection="costIds" index="index" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
        GROUP BY
        orc.currency_code
    </select>
    <select id="findCostClass" parameterType="java.util.List" resultType="com.jayud.finance.vo.ViewBillToCostClassVO">
        SELECT
        CONCAT( orc.cost_code, orc.currency_code ) NAME,
        orc.main_order_no orderNo,
        orc.order_no subOrderNo,
        concat((SELECT ci.NAME FROM cost_info ci WHERE ci.id_code = orc.cost_code),'(',(
        SELECT ci.currency_name FROM currency_info ci WHERE ci.currency_code = orc.currency_code),')') viewName,
        sum( orc.amount ) money
        FROM
        order_receivable_cost orc
        WHERE
        orc.id IN
        <foreach collection="costIds" index="index" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
        GROUP BY
        orc.cost_code,
        orc.currency_code,
        orc.main_order_no,
        orc.order_no

        union

        SELECT
        CONCAT( 'T', orc.currency_code ) NAME,
        orc.main_order_no orderNo,
        orc.order_no subOrderNo,
        concat('合计(',(
        SELECT ci.currency_name FROM currency_info ci WHERE ci.currency_code = orc.currency_code),')') viewName,
        sum( orc.amount ) money
        FROM
        order_receivable_cost orc
        WHERE
        orc.id IN
        <foreach collection="costIds" index="index" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
        GROUP BY
        orc.currency_code,
        orc.main_order_no,
        orc.order_no
    </select>
    <select id="viewReceiveBill" parameterType="java.util.List" resultType="com.jayud.finance.vo.ViewBilToOrderVO">
        SELECT
        DATE_FORMAT( oi.create_time, '%Y-%m-%d' ) createdTimeStr,
        oi.order_no orderNo,
        orc.order_no subOrderNo,
        ci.`name` unitAccount,
        ( SELECT GROUP_CONCAT(ota.goods_desc) FROM order_take_adr ota LEFT JOIN order_transport ot on ota.order_no =
        ot.order_no where ot.main_order_no = oi.order_no and ota.opr_type = '1' group by ot.order_no) goodsDesc,
        ( SELECT GROUP_CONCAT(concat(ifnull(da.city_name,''), da.address )) FROM delivery_address da LEFT JOIN
        order_take_adr ota on da.id = ota.delivery_id LEFT JOIN order_transport ot on ota.order_no = ot.order_no where
        ot.main_order_no = oi.order_no and ota.opr_type = '1' group by ot.order_no) startAddress,
        ( SELECT GROUP_CONCAT(concat(ifnull(da.city_name,''), da.address )) FROM delivery_address da LEFT JOIN
        order_take_adr ota on da.id = ota.delivery_id LEFT JOIN order_transport ot on ota.order_no = ot.order_no where
        ot.main_order_no = oi.order_no and ota.opr_type = '2' group by ot.order_no) endAddress,
        (select concat(vi.plate_number,' ',vi.hk_number) from order_send_cars osc left join order_transport ot on
        osc.order_no = ot.order_no left join vehicle_info vi on
        vi.id = osc.vehicle_id where ot.main_order_no = oi.order_no) licensePlate,
        (select ot.vehicle_size from order_transport ot where ot.main_order_no = oi.order_no) vehicleSize,
        (select sum(ota.piece_amount) from order_take_adr ota left join order_transport ot on ota.order_no = ot.order_no
        where ot.main_order_no = oi.order_no and ota.opr_type = '1') pieceNum,
        (select sum(ota.weight) from order_take_adr ota left join order_transport ot on ota.order_no = ot.order_no where
        ot.main_order_no = oi.order_no and ota.opr_type = '1') weight,
        (select GROUP_CONCAT(oc.yun_customs_no,',') from order_customs oc where oc.main_order_no = oi.order_no)
        yunCustomsNo,
        orc.department_id,orc.is_internal,oi.biz_belong_depart
        FROM
        order_info oi
        left join order_receivable_cost orc on orc.main_order_no = oi.order_no
        left join customer_info ci on ci.id_code = orc.customer_code
        where 1 = 1
        <if test="costIds != null and costIds.size>0">
            and orc.id in
            <foreach collection="costIds" index="index" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="costIds = null or costIds.size == 0">
            and 1 = 0
        </if>
        group by orderNo,subOrderNo
    </select>
    <select id="getViewBillByCostIds" parameterType="java.util.Map" resultType="com.jayud.finance.vo.ViewBillVO">

        <choose>
            <when test="cmd == 'cci' or cmd == 'cce' or cmd == 'ccf'">
                SELECT DISTINCT
                <if test="cmd == 'main'">
                    oi.legal_name legalName,
                    oi.legal_entity_id,
                </if>
                orc.legal_name legalName,
                orc.legal_id legalEntityId,

                <!--        <if test="cmd == 'bg'">-->
                <!--            oc.legal_name legalName,-->
                <!--        </if>-->
                <!--        <if test="cmd == 'zgys'">-->
                <!--            ot.legal_name legalName,-->
                <!--        </if>-->
                <!--        <if test="cmd == 'ky'">-->
                <!--            ao.legal_name legalName,-->
                <!--        </if>-->
                ci.`name` customerName
                FROM
                <if test="cmd == 'main'">
                    order_info oi LEFT JOIN order_receivable_cost orc ON oi.order_no = orc.main_order_no
                </if>

                <!--        <if test="cmd == 'bg'">-->
                <!--            order_customs oc LEFT JOIN order_receivable_cost orc on oc.order_no = orc.order_no-->
                <!--        </if>-->
                <!--        <if test="cmd == 'zgys'">-->
                <!--            order_transport ot LEFT JOIN order_receivable_cost orc on ot.order_no = orc.order_no-->
                <!--        </if>-->
                <!--        <if test="cmd == 'ky'">-->
                <!--            air_order ao LEFT JOIN order_receivable_cost orc on ao.order_no = orc.order_no-->
                <!--        </if>-->
                left join customer_info ci on ci.id_code = orc.customer_code
                WHERE
                orc.id IN
                <foreach collection="costIds" index="index" item="item" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </when>
            <otherwise>
                SELECT DISTINCT
                <if test="cmd == 'main'">
                    oi.legal_name legalName,
                    oi.legal_entity_id,
                </if>
                <if test="dynamicSqlParam.table !=null and dynamicSqlParam.table != ''">
                    sub.legal_name legalName,
                    sub.legal_entity_id,
                </if>
                <!--        <if test="cmd == 'bg'">-->
                <!--            oc.legal_name legalName,-->
                <!--        </if>-->
                <!--        <if test="cmd == 'zgys'">-->
                <!--            ot.legal_name legalName,-->
                <!--        </if>-->
                <!--        <if test="cmd == 'ky'">-->
                <!--            ao.legal_name legalName,-->
                <!--        </if>-->
                ci.`name` customerName
                FROM
                <if test="cmd == 'main'">
                    order_info oi LEFT JOIN order_receivable_cost orc ON oi.order_no = orc.main_order_no
                </if>
                <if test="dynamicSqlParam.table !=null and dynamicSqlParam.table != ''">
                    ${dynamicSqlParam.table} sub LEFT JOIN order_receivable_cost orc on sub.order_no = orc.order_no
                </if>

                <!--        <if test="cmd == 'bg'">-->
                <!--            order_customs oc LEFT JOIN order_receivable_cost orc on oc.order_no = orc.order_no-->
                <!--        </if>-->
                <!--        <if test="cmd == 'zgys'">-->
                <!--            order_transport ot LEFT JOIN order_receivable_cost orc on ot.order_no = orc.order_no-->
                <!--        </if>-->
                <!--        <if test="cmd == 'ky'">-->
                <!--            air_order ao LEFT JOIN order_receivable_cost orc on ao.order_no = orc.order_no-->
                <!--        </if>-->
                left join customer_info ci on ci.id_code = orc.customer_code
                WHERE
                orc.id IN
                <foreach collection="costIds" index="index" item="item" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </otherwise>
        </choose>

        <!--        SELECT DISTINCT-->
        <!--        <if test="cmd == 'main'">-->
        <!--            oi.legal_name legalName,-->
        <!--        </if>-->
        <!--        <if test="dynamicSqlParam.table !=null and dynamicSqlParam.table != ''">-->
        <!--            sub.legal_name legalName,-->
        <!--        </if>-->
        <!--        &lt;!&ndash;        <if test="cmd == 'bg'">&ndash;&gt;-->
        <!--        &lt;!&ndash;            oc.legal_name legalName,&ndash;&gt;-->
        <!--        &lt;!&ndash;        </if>&ndash;&gt;-->
        <!--        &lt;!&ndash;        <if test="cmd == 'zgys'">&ndash;&gt;-->
        <!--        &lt;!&ndash;            ot.legal_name legalName,&ndash;&gt;-->
        <!--        &lt;!&ndash;        </if>&ndash;&gt;-->
        <!--        &lt;!&ndash;        <if test="cmd == 'ky'">&ndash;&gt;-->
        <!--        &lt;!&ndash;            ao.legal_name legalName,&ndash;&gt;-->
        <!--        &lt;!&ndash;        </if>&ndash;&gt;-->
        <!--        ci.`name` customerName-->
        <!--        FROM-->
        <!--        <if test="cmd == 'main'">-->
        <!--            order_info oi LEFT JOIN order_receivable_cost orc ON oi.order_no = orc.main_order_no-->
        <!--        </if>-->
        <!--        <if test="dynamicSqlParam.table !=null and dynamicSqlParam.table != ''">-->
        <!--            ${dynamicSqlParam.table} sub LEFT JOIN order_receivable_cost orc on sub.order_no = orc.order_no-->
        <!--        </if>-->

        <!--        &lt;!&ndash;        <if test="cmd == 'bg'">&ndash;&gt;-->
        <!--        &lt;!&ndash;            order_customs oc LEFT JOIN order_receivable_cost orc on oc.order_no = orc.order_no&ndash;&gt;-->
        <!--        &lt;!&ndash;        </if>&ndash;&gt;-->
        <!--        &lt;!&ndash;        <if test="cmd == 'zgys'">&ndash;&gt;-->
        <!--        &lt;!&ndash;            order_transport ot LEFT JOIN order_receivable_cost orc on ot.order_no = orc.order_no&ndash;&gt;-->
        <!--        &lt;!&ndash;        </if>&ndash;&gt;-->
        <!--        &lt;!&ndash;        <if test="cmd == 'ky'">&ndash;&gt;-->
        <!--        &lt;!&ndash;            air_order ao LEFT JOIN order_receivable_cost orc on ao.order_no = orc.order_no&ndash;&gt;-->
        <!--        &lt;!&ndash;        </if>&ndash;&gt;-->
        <!--        left join customer_info ci on ci.id_code = orc.customer_code-->
        <!--        WHERE-->
        <!--        orc.id IN-->
        <!--        <foreach collection="costIds" index="index" item="item" open="(" separator="," close=")">-->
        <!--            #{item}-->
        <!--        </foreach>-->
    </select>
    <select id="findSaveConfirmData" parameterType="java.util.List" resultType="java.lang.Long">
        SELECT
        orc.id
        FROM
        order_receivable_cost orc
        WHERE
        orc.is_bill = 'save_confirm'
        AND orc.id in
        <foreach collection="costIds" index="index" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>
    <select id="getWarehouseAddress" parameterType="java.lang.String" resultType="java.lang.String">
        SELECT concat(IFNULL(( SELECT rc.`name` FROM region_city rc WHERE rc.id = wi.state_code),''),
            IFNULL(( SELECT rc.`name` FROM region_city rc WHERE rc.id = wi.city_code ),''),
            IFNULL(( SELECT rc.`name` FROM region_city rc WHERE rc.id = wi.area_code ),''),
            wi.address
        ) detailAddress
        FROM
            order_info oi
            LEFT JOIN order_transport ot ON oi.order_no = ot.main_order_no
            LEFT JOIN warehouse_info wi ON wi.id = ot.warehouse_info_id
            where oi.order_no = #{orderNo}
    </select>

    <!--    <select id="findReceiveBillByPage" resultType="com.jayud.finance.vo.OrderReceiveBillVO">-->
    <!--        SELECT DISTINCT-->
    <!--        oi.legal_name legalName,-->
    <!--        oi.legal_entity_id legalEntityId,-->
    <!--        ci.`name` unitAccount,-->
    <!--        ci.id_code unitCode,-->
    <!--        ifnull( orb.already_paid_amount, 0 ) alreadyPaidAmount,-->
    <!--        ifnull( orb.bill_order_num, 0 ) billOrderNum,-->
    <!--        ifnull( orb.bill_num, 0 ) billNum-->
    <!--        &#45;&#45;         (select ifnull(sum(t1.change_amount),0) from order_receivable_cost t1 where t1.is_bill != '2' AND t1.is_bill !=-->
    <!--        &#45;&#45;         'save_confirm' AND-->
    <!--        &#45;&#45;         t1.is_sum_to_main = '1' and t1.status = '3' and t1.customer_code = orc.customer_code and t1.main_order_no in-->
    <!--        &#45;&#45;         (select o1.order_no from order_info o1 where o1.legal_name = oi.legal_name)) notPaidAmount,-->
    <!--        &#45;&#45;         (select count(DISTINCT t1.main_order_no) from order_receivable_cost t1 where t1.is_bill != '2' AND t1.is_bill !=-->
    <!--        &#45;&#45;         'save_confirm' AND-->
    <!--        &#45;&#45;         t1.is_sum_to_main = '1' and t1.status = '3' and t1.customer_code = orc.customer_code and t1.main_order_no in-->
    <!--        &#45;&#45;         (select o1.order_no from order_info o1 where o1.legal_name = oi.legal_name)) notPaidOrderNum-->
    <!--        FROM-->
    <!--        order_receivable_cost orc-->
    <!--        left join customer_info ci on ci.id_code = orc.customer_code-->
    <!--        LEFT JOIN order_info oi ON oi.order_no = orc.main_order_no-->
    <!--        left join order_receivable_bill orb on orb.legal_entity_id = oi.legal_entity_id-->
    <!--        and orb.unit_code = ci.id_code and orb.is_main=1-->
    <!--        where orc.is_sum_to_main = 1 and orc.status = '3'-->
    <!--        <if test="form.unitAccount != null and form.unitAccount != ''">-->
    <!--            and ci.`name` like concat('%',#{form.unitAccount},'%')-->
    <!--        </if>-->
    <!--        <if test="form.legalName != null and form.legalName != ''">-->
    <!--            and oi.legal_name like concat('%',#{form.legalName},'%')-->
    <!--        </if>-->

    <!--        <if test="legalIds != null and legalIds.size>0">-->
    <!--            and oi.`legal_entity_id` in-->
    <!--            <foreach collection="legalIds" item="legalId" open="(" separator="," close=")">-->
    <!--                #{legalId}-->
    <!--            </foreach>-->
    <!--        </if>-->
    <!--    </select>-->


    <select id="findReceiveBillByPage" resultType="com.jayud.finance.vo.OrderReceiveBillVO">
        SELECT
        oi.legal_name legalName,
        oi.legal_entity_id legalEntityId,
        ci.`name` unitAccount,
        ci.id_code unitCode,
        ifnull( orb.already_paid_amount, 0 ) alreadyPaidAmount,
        ifnull( orb.bill_order_num, 0 ) billOrderNum,
        ifnull( orb.bill_num, 0 ) billNum
        FROM
        order_receivable_cost orc
        left join customer_info ci on ci.id_code = orc.customer_code
        LEFT JOIN order_info oi ON oi.order_no = orc.main_order_no
        left join order_receivable_bill orb on orb.legal_entity_id = oi.legal_entity_id
        and orb.unit_code = ci.id_code and orb.is_main=1
        where orc.is_sum_to_main = 1 and orc.status = '3'
        <if test="form.unitAccount != null and form.unitAccount != ''">
            and ci.`name` like concat('%',#{form.unitAccount},'%')
        </if>
        <if test="form.legalName != null and form.legalName != ''">
            and oi.legal_name like concat('%',#{form.legalName},'%')
        </if>

        <if test="legalIds != null and legalIds.size>0">
            and oi.`legal_entity_id` in
            <foreach collection="legalIds" item="legalId" open="(" separator="," close=")">
                #{legalId}
            </foreach>
        </if>
        group by oi.legal_entity_id, orc.customer_code
    </select>
<!--    <select id="findReceiveSubBillByPage" resultType="com.jayud.finance.vo.OrderReceiveBillVO">-->
<!--        SELECT DISTINCT-->

<!--        &#45;&#45; 仓储-->
<!--        <choose>-->
<!--            <when test="form.cmd == 'cci' or form.cmd == 'cce' or form.cmd == 'ccf'">-->
<!--                <if test="form.cmd != null and form.cmd != ''">-->
<!--                    le.legal_name legalName,-->
<!--                    orc.legal_id legalEntityId,-->
<!--                    (select ifnull(sum(t1.change_amount),0) from order_receivable_cost t1 where t1.is_bill != '2' AND-->
<!--                    t1.is_bill-->
<!--                    != 'save_confirm' AND-->
<!--                    t1.is_sum_to_main = '0' and t1.status = '3' and t1.sub_type=#{form.cmd} and t1.customer_code =-->
<!--                    orc.customer_code and t1.legal_id = orc.legal_id) notPaidAmount,-->
<!--                    (select count(DISTINCT t1.main_order_no) from order_receivable_cost t1 where t1.is_bill != '2' AND-->
<!--                    t1.is_bill != 'save_confirm' AND-->
<!--                    t1.is_sum_to_main = '0' and t1.status = '3' and t1.sub_type=#{form.cmd} and t1.customer_code =-->
<!--                    orc.customer_code and t1.legal_id = orc.legal_id) notPaidOrderNum,-->
<!--                </if>-->
<!--                ci.`name` unitAccount,-->
<!--                orc.customer_code unitCode,-->
<!--                ifnull( orb.already_paid_amount, 0 ) alreadyPaidAmount,-->
<!--                ifnull( orb.bill_order_num, 0 ) billOrderNum,-->
<!--                ifnull( orb.bill_num, 0 ) billNum-->
<!--                FROM-->
<!--                order_receivable_cost orc-->
<!--                left join customer_info ci on ci.id_code = orc.customer_code-->
<!--                left join legal_entity le on orc.legal_id = le.id-->
<!--                left join order_receivable_bill orb on orb.legal_entity_id = orc.legal_id-->
<!--                and orb.unit_code = orc.customer_code-->
<!--                and orb.sub_type = #{form.cmd}-->
<!--                where orc.is_sum_to_main = 0 and orc.sub_type = #{form.cmd} and orc.status = '3'-->
<!--                <if test="form.unitAccount != null and form.unitAccount != ''">-->
<!--                    and ci.`name` like concat('%',#{form.unitAccount},'%')-->
<!--                </if>-->
<!--                <if test="form.legalName != null and form.legalName != ''">-->
<!--                    and le.legal_name like concat('%',#{form.legalName},'%')-->
<!--                </if>-->
<!--                <if test="legalIds != null and legalIds.size>0">-->
<!--                    and orc.`legal_id` in-->
<!--                    <foreach collection="legalIds" item="legalId" open="(" separator="," close=")">-->
<!--                        #{legalId}-->
<!--                    </foreach>-->
<!--                </if>-->

<!--            </when>-->
<!--            <otherwise>-->
<!--                <if test="form.cmd != null and form.cmd != ''">-->
<!--                    le.legal_name legalName,-->
<!--                    sub.legal_entity_id legalEntityId,-->
<!--                </if>-->
<!--                ci.`name` unitAccount,-->
<!--                orc.customer_code unitCode,-->
<!--                ifnull( orb.already_paid_amount, 0 ) alreadyPaidAmount,-->
<!--                ifnull( orb.bill_order_num, 0 ) billOrderNum,-->
<!--                ifnull( orb.bill_num, 0 ) billNum-->
<!--                FROM-->
<!--                order_receivable_cost orc-->
<!--                left join customer_info ci on ci.id_code = orc.customer_code-->
<!--                <if test="form.cmd != null and form.cmd != ''">-->
<!--                    left join ${dynamicSqlParam.table} sub on sub.order_no = orc.order_no-->
<!--                    left join legal_entity le on sub.legal_entity_id = le.id-->
<!--                    left join order_receivable_bill orb on orb.legal_entity_id = sub.legal_entity_id-->
<!--                    and orb.unit_code = orc.customer_code-->
<!--                    and orb.sub_type = #{form.cmd}-->
<!--                    where orc.is_sum_to_main = 0 and orc.sub_type = #{form.cmd} and orc.status = '3'-->
<!--                    <if test="form.unitAccount != null and form.unitAccount != ''">-->
<!--                        and ci.`name` like concat('%',#{form.unitAccount},'%')-->
<!--                    </if>-->
<!--                    <if test="form.legalName != null and form.legalName != ''">-->
<!--                        and le.legal_name like concat('%',#{form.legalName},'%')-->
<!--                    </if>-->
<!--                    <if test="legalIds != null and legalIds.size>0">-->
<!--                        and sub.`legal_entity_id` in-->
<!--                        <foreach collection="legalIds" item="legalId" open="(" separator="," close=")">-->
<!--                            #{legalId}-->
<!--                        </foreach>-->
<!--                    </if>-->
<!--                </if>-->
<!--            </otherwise>-->
<!--        </choose>-->
<!--    </select>-->


    <select id="findReceiveSubBillByPage" resultType="com.jayud.finance.vo.OrderReceiveBillVO">
        SELECT DISTINCT

        -- 仓储
        <choose>
            <when test="form.cmd == 'cci' or form.cmd == 'cce' or form.cmd == 'ccf'">
                <if test="form.cmd != null and form.cmd != ''">
                    le.legal_name legalName,
                    orc.legal_id legalEntityId,
                    (select ifnull(sum(t1.change_amount),0) from order_receivable_cost t1 where t1.is_bill != '2' AND
                    t1.is_bill
                    != 'save_confirm' AND
                    t1.is_sum_to_main = '0' and t1.status = '3' and t1.sub_type=#{form.cmd} and t1.customer_code =
                    orc.customer_code and t1.legal_id = orc.legal_id) notPaidAmount,
                    (select count(DISTINCT t1.main_order_no) from order_receivable_cost t1 where t1.is_bill != '2' AND
                    t1.is_bill != 'save_confirm' AND
                    t1.is_sum_to_main = '0' and t1.status = '3' and t1.sub_type=#{form.cmd} and t1.customer_code =
                    orc.customer_code and t1.legal_id = orc.legal_id) notPaidOrderNum,
                </if>
                ci.`name` unitAccount,
                orc.customer_code unitCode,
                ifnull( orb.already_paid_amount, 0 ) alreadyPaidAmount,
                ifnull( orb.bill_order_num, 0 ) billOrderNum,
                ifnull( orb.bill_num, 0 ) billNum
                FROM
                order_receivable_cost orc
                left join customer_info ci on ci.id_code = orc.customer_code
                left join legal_entity le on orc.legal_id = le.id
                left join order_receivable_bill orb on orb.legal_entity_id = orc.legal_id
                and orb.unit_code = orc.customer_code
                and orb.sub_type = #{form.cmd}
                where orc.is_sum_to_main = 0 and orc.sub_type = #{form.cmd} and orc.status = '3'
                <if test="form.unitAccount != null and form.unitAccount != ''">
                    and ci.`name` like concat('%',#{form.unitAccount},'%')
                </if>
                <if test="form.legalName != null and form.legalName != ''">
                    and le.legal_name like concat('%',#{form.legalName},'%')
                </if>
                <if test="legalIds != null and legalIds.size>0">
                    and orc.`legal_id` in
                    <foreach collection="legalIds" item="legalId" open="(" separator="," close=")">
                        #{legalId}
                    </foreach>
                </if>

            </when>
            <otherwise>
                <if test="form.cmd != null and form.cmd != ''">
                    le.legal_name legalName,
                    orc.legal_id legalEntityId,
                </if>
                ci.`name` unitAccount,
                orc.customer_code unitCode,
                ifnull( orb.already_paid_amount, 0 ) alreadyPaidAmount,
                ifnull( orb.bill_order_num, 0 ) billOrderNum,
                ifnull( orb.bill_num, 0 ) billNum
                FROM
                order_receivable_cost orc
                left join customer_info ci on ci.id_code = orc.customer_code
                <if test="form.cmd != null and form.cmd != ''">
                    left join legal_entity le on orc.legal_id = le.id
                    left join order_receivable_bill orb on orb.legal_entity_id = orc.legal_id
                    and orb.unit_code = orc.customer_code
                    and orb.sub_type = #{form.cmd}
                    where orc.is_sum_to_main = 0 and orc.sub_type = #{form.cmd} and orc.status = '3'
                    <if test="form.unitAccount != null and form.unitAccount != ''">
                        and ci.`name` like concat('%',#{form.unitAccount},'%')
                    </if>
                    <if test="form.legalName != null and form.legalName != ''">
                        and le.legal_name like concat('%',#{form.legalName},'%')
                    </if>
                    <if test="legalIds != null and legalIds.size>0">
                        and orc.`legal_id` in
                        <foreach collection="legalIds" item="legalId" open="(" separator="," close=")">
                            #{legalId}
                        </foreach>
                    </if>
                </if>
            </otherwise>
        </choose>

    </select>

    <!--    <select id="statisticsNotPaidBillInfo" resultType="java.util.Map">-->
    <!--        select-->
    <!--        t1.main_order_no mainOrderNo, t1.order_no orderNo,-->
    <!--        t1.change_amount changeAmount-->
    <!--        from order_receivable_cost t1-->
    <!--        <choose>-->
    <!--            <when test="isMain">-->
    <!--                left join order_info o1 on-->
    <!--                o1.order_no = t1.main_order_no-->
    <!--            </when>-->
    <!--            <otherwise>-->
    <!--                left join ${dynamicSqlParam.table} o1 on-->
    <!--                o1.order_no = t1.order_no-->
    <!--            </otherwise>-->
    <!--        </choose>-->
    <!--        <where>-->
    <!--            and t1.is_bill in('0','1')-->
    <!--            and t1.is_sum_to_main = #{isMain}-->
    <!--            and t1.status = 3-->
    <!--            and t1.customer_code in-->
    <!--            <foreach collection="customerCodes" item="customerCode" open="(" separator="," close=")">-->
    <!--                #{customerCode}-->
    <!--            </foreach>-->
    <!--            <if test="legalName != null and legalName.size>0">-->
    <!--                and o1.legal_name in-->
    <!--                <foreach collection="legalNames" item="legalName" open="(" separator="," close=")">-->
    <!--                    #{legalName}-->
    <!--                </foreach>-->
    <!--            </if>-->
    <!--            <if test="legalEntityIds != null and legalEntityIds.size>0">-->
    <!--                and o1.legal_name in-->
    <!--            </if>-->
    <!--            &lt;!&ndash;            <choose>&ndash;&gt;-->
    <!--            &lt;!&ndash;                <when test="isMain">&ndash;&gt;-->
    <!--            &lt;!&ndash;                    and t1.main_order_no in (select o1.order_no from order_info o1 where o1.legal_name =&ndash;&gt;-->
    <!--            &lt;!&ndash;                    #{legalName})&ndash;&gt;-->
    <!--            &lt;!&ndash;                </when>&ndash;&gt;-->
    <!--            &lt;!&ndash;                <otherwise>&ndash;&gt;-->
    <!--            &lt;!&ndash;                    and t1.order_no in (select o1.order_no from ${dynamicSqlParam.table} o1 where o1.legal_entity_id =&ndash;&gt;-->
    <!--            &lt;!&ndash;                    #{legalEntityId})&ndash;&gt;-->
    <!--            &lt;!&ndash;                </otherwise>&ndash;&gt;-->
    <!--            &lt;!&ndash;            </choose>&ndash;&gt;-->
    <!--        </where>-->
    <!--    </select>-->

    <select id="statisticsNotPaidBillInfo" resultType="java.util.Map">
        select
        t1.main_order_no mainOrderNo, t1.order_no orderNo,
        t1.change_amount changeAmount
        from order_receivable_cost t1
        <where>
            and t1.is_bill in('0','1')
            and t1.is_sum_to_main = #{isMain}
            and t1.status = 3
            and t1.customer_code = #{customerCode}
            <choose>
                <when test="isMain">
                    and t1.main_order_no in (select o1.order_no from order_info o1 where o1.legal_entity_id =
                    #{legalEntityId})
                </when>
                <when test="dynamicSqlParam.table == 'storage_input_order' or dynamicSqlParam.table == 'storage_out_order' ">
                    and t1.legal_id = #{legalEntityId}
                </when>
                <otherwise>
                    and t1.order_no in (select o1.order_no from ${dynamicSqlParam.table} o1 where o1.legal_entity_id =
                    #{legalEntityId})
                </otherwise>
            </choose>
        </where>
    </select>

    <select id="getCountByMakeTime" resultType="java.lang.Integer">
        select count(distinct bill_no) from order_receivable_bill_detail
        where  DATE_FORMAT( make_time, #{format})=#{makeTime}
    </select>

    <select id="getUnpaidData" resultType="com.jayud.finance.vo.UnbilledVO">
        SELECT
        orc.legal_id,
        orc.customer_code,
        orc.change_amount,
        orc.main_order_no,
        orc.order_no
        FROM
        order_receivable_cost orc
        <where>
            orc.id NOT IN (SELECT orbd.cost_id FROM order_receivable_bill_detail orbd where
            orbd.audit_status!='edit_del')
            and (orc.is_bill != '2' and orc.is_bill!='save_confirm')
            and orc.`status` = '3'
            and orc.customer_code in
            <foreach collection="customerCodes" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
            and orc.legal_id in
            <foreach collection="legalIds" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
            and orc.is_sum_to_main = 0 and orc.sub_type = #{cmd}
        </where>
    </select>
</mapper>
