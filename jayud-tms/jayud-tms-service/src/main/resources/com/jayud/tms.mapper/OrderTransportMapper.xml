<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jayud.tms.mapper.OrderTransportMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.jayud.tms.model.po.OrderTransport">
        <id column="id" property="id"/>
        <result column="main_order_no" property="mainOrderNo"/>
        <result column="order_no" property="orderNo"/>
        <result column="port_code" property="portCode"/>
        <result column="goods_type" property="goodsType"/>
        <result column="vehicle_type" property="vehicleType"/>
        <result column="vehicle_size" property="vehicleSize"/>
        <result column="cntr_no" property="cntrNo"/>
        <result column="cntr_pic" property="cntrPic"/>
        <result column="cntr_pic_name" property="cntrPicName"/>
        <result column="warehouse_info_id" property="warehouseInfoId"/>
        <result column="status" property="status"/>
        <result column="is_load_goods" property="isLoadGoods"/>
        <result column="is_unload_goods" property="isUnloadGoods"/>
        <result column="unit_code" property="unitCode"/>
        <result column="legal_name" property="legalName"/>
        <result column="legal_entity_id" property="legalEntityId"/>
        <result column="hk_unit_code" property="hkUnitCode"/>
        <result column="hk_legal_id" property="hkLegalId"/>
        <result column="hk_legal_name" property="hkLegalName"/>
        <result column="is_hk_clear" property="isHkClear"/>
        <result column="jiedan_user" property="jiedanUser"/>
        <result column="jiedan_time" property="jiedanTime"/>
        <result column="car_weigh_num" property="carWeighNum"/>
        <result column="updated_time" property="updatedTime"/>
        <result column="updated_user" property="updatedUser"/>
        <result column="created_time" property="createdTime"/>
        <result column="created_user" property="createdUser"/>
        <result column="driver_info_id" property="driverInfoId"/>
        <result column="vehicle_id" property="vehicleId"/>
        <result column="is_vehicle_weigh" property="isVehicleWeigh"/>
    </resultMap>

    <resultMap id="ResultMap" type="com.jayud.tms.model.vo.OrderVO">
        <id column="id" property="id"/>
        <result column="main_order_no" property="mainOrderNo"/>
        <result column="order_no" property="orderNo"/>
        <result column="status" property="status"/>
        <collection property="orderTakeAdrs" ofType="com.jayud.tms.model.vo.OrderTakeAdrVO" javaType="list">
            <id column="id" property="id"/>
            <result column="order_no" property="orderNo"/>
            <result column="delivery_id" property="deliveryId"/>
            <result column="take_time" property="takeTime"/>
            <result column="goods_desc" property="goodsDesc"/>
            <result column="plate_amount" property="plateAmount"/>
            <result column="piece_amount" property="pieceAmount"/>
            <result column="weight" property="weight"/>
            <result column="volume" property="volume"/>
            <result column="remarks" property="remarks"/>
            <result column="opr_type" property="oprType"/>
        </collection>
    </resultMap>

    <resultMap id="ResultOneMap" type="com.jayud.tms.model.vo.OrderTransportInfoVO">
        <id column="id" property="id"/>
        <result column="main_order_no" property="mainOrderNo"/>
        <result column="order_no" property="orderNo"/>
        <result column="status" property="status"/>
        <result column="seamless_no" property="seamlessNo"/>
        <association property="orderSendCars" javaType="com.jayud.tms.model.vo.OrderSendCarsInfoVO">
            <id column="id" property="id"/>
            <result column="transport_no" property="transportNo"/>
            <result column="order_no" property="orderNo"/>
            <result column="vehicle_type" property="vehicleType"/>
            <result column="vehicle_size" property="vehicleSize"/>
            <result column="cntr_no" property="cntrNo"/>
            <result column="cntr_pic" property="cntrPic"/>
            <result column="cntr_pic_name" property="cntrPicName"/>
            <result column="driver_info_info" property="driverInfoId"/>
            <result column="vehicle_id" property="vehicleId"/>
            <result column="remarks" property="remarks"/>
            <result column="describes" property="describes"/>
            <result column="status" property="status"/>
            <result column="updated_time" property="updatedTime"/>
            <result column="created_user" property="createdUser"/>
            <result column="created_time" property="createdTime"/>
            <result column="updated_user" property="updatedUser"/>
            <result column="jockey_id" property="jockeyId"/>
            <result column="jockey" property="jockey"/>
        </association>
    </resultMap>
    <resultMap id="ResultTwoMap" type="com.jayud.tms.model.vo.OrderTransportInfoVO">
        <id column="id" property="id"/>
        <result column="main_order_no" property="mainOrderNo"/>
        <result column="order_no" property="orderNo"/>
        <result column="port_code" property="portCode"/>
        <result column="goods_type" property="goodsType"/>
        <result column="vehicle_type" property="vehicleType"/>
        <result column="vehicle_size" property="vehicleSize"/>
        <result column="cntr_no" property="cntrNo"/>
        <result column="cntr_pic" property="cntrPic"/>
        <result column="cntr_pic_name" property="cntrPicName"/>
        <result column="warehouse_info_id" property="warehouseInfoId"/>
        <result column="status" property="status"/>
        <result column="is_load_goods" property="isLoadGoods"/>
        <result column="is_unload_goods" property="isUnloadGoods"/>
        <result column="unit_code" property="unitCode"/>
        <result column="legal_name" property="legalName"/>
        <result column="legal_entity_id" property="legalEntityId"/>
        <result column="hk_unit_code" property="hkUnitCode"/>
        <result column="hk_legal_id" property="hkLegalId"/>
        <result column="hk_legal_name" property="hkLegalName"/>
        <result column="is_hk_clear" property="isHkClear"/>
        <result column="jiedan_user" property="jiedanUser"/>
        <result column="jiedan_time" property="jiedanTime"/>
        <result column="car_weigh_num" property="carWeighNum"/>
        <result column="updated_time" property="updatedTime"/>
        <result column="updated_user" property="updatedUser"/>
        <result column="created_time" property="createdTime"/>
        <result column="created_user" property="createdUser"/>
        <result column="driver_info_id" property="driverInfoId"/>
        <result column="vehicle_id" property="vehicleId"/>
        <result column="is_vehicle_weigh" property="isVehicleWeigh"/>
        <result column="supplier_id" property="supplierId"/>
        <result column="supplier_vehicle_size" property="supplierVehicleSize"/>
        <association property="orderSendCars" javaType="com.jayud.tms.model.vo.OrderSendCarsInfoVO">
            <id column="sendCarId" property="id"/>
            <result column="transport_no" property="transportNo"/>
            <result column="order_no" property="orderNo"/>
            <result column="vehicle_type" property="vehicleType"/>
            <result column="vehicle_size" property="vehicleSize"/>
            <result column="cntr_no" property="cntrNo"/>
            <result column="cntr_pic" property="cntrPic"/>
            <result column="cntr_pic_name" property="cntrPicName"/>
            <result column="driver_info_id" property="driverInfoId"/>
            <result column="vehicle_id" property="vehicleId"/>
            <result column="remarks" property="remarks"/>
            <result column="describes" property="describes"/>
            <result column="status" property="status"/>
            <result column="updated_time" property="updatedTime"/>
            <result column="created_user" property="createdUser"/>
            <result column="created_time" property="createdTime"/>
            <result column="updated_user" property="updatedUser"/>
            <result column="jockey_id" property="jockeyId"/>
            <result column="jockey" property="jockey"/>
        </association>
    </resultMap>


    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id, main_order_no, order_no, port_code, goods_type, vehicle_type, vehicle_size, cntr_no, cntr_pic, cntrPicName,
        warehouse_info_id, status, is_load_goods, is_unload_goods,unit_code, hk_unit_code,hk_legal_id,hk_legal_name,is_hk_clear,
        updated_time, updated_user, created_time,created_user,jiedan_user,jiedan_time,car_weigh_num,legal_name,need_input_cost,
        driver_info_id,is_vehicle_weigh
    </sql>

    <select id="getOrderTransport" resultType="com.jayud.tms.model.vo.InputOrderTransportVO">
        SELECT
          ot.id,
          ot.`order_no` orderNo,
          ot.`jiedan_user` jiedanUser,
          le.`legal_name` legalName,
          ot.legal_entity_id legalEntityId,
          DATE_FORMAT(ot.`jiedan_time`,'%Y-%m-%d %H:%i:%S') jiedanTimeStr,
          ot.`goods_type` goodsType,
          ot.`port_code` portCode,
          ot.`unit_code` unitCode,
          p.`name` portName,
          ot.`status`,
          vi.hk_number hkLicensePlate,
          vi.plate_number licensePlate,
          ot.`vehicle_size` vehicleSize,
          ot.`vehicle_type` vehicleType,
          ot.`cntr_no` cntrNo,
          ot.`warehouse_info_id` warehouseInfoId,
          si.`supplier_ch_name` supplierChName,
          si.supplier_code defaultSupplierCode,
          si.app_key appKey,
          si.gps_address gpsAddress,
          '' customsNo,
          di.`name` driverName,
          di.phone driverPhone,
          di.hk_phone driverHkPhone,
          ot.`car_weigh_num` carWeighNum,
          ot.`seamless_no`  seamlessNo,
          ot.`clear_customs_no` clearCustomsNo,
          osc.`remarks`,
          ot.`cntr_pic` cntrPic,
          ot.`cntr_pic_name` cntrPicName,
          wi.`warehouse_name` companyName,
          wi.`contacts` contacts,
          wi.`contact_number` contactNumber,
          wi.`address` address,
          ot.`is_load_goods` isLoadGoods,
          ot.`is_unload_goods` isUnloadGoods,
          ot.`hk_legal_name` hkLegalName,
          ot.hk_legal_id hkLegalId,
          ot.`hk_unit_code` hkUnitCode,
          ot.`is_hk_clear` isHkClear,
		  ot.is_vehicle_weigh isVehicleWeigh,
		  ot.supplier_vehicle_size,
		  ot.department_id
        FROM
          order_transport ot
          LEFT JOIN order_info oi
            ON ot.`main_order_no` = oi.`order_no`
          LEFT JOIN legal_entity le
            ON ot.legal_entity_id =le.id
          LEFT JOIN port_info p
            ON ot.`port_code` = p.`id_code`
          LEFT JOIN order_send_cars osc
            ON osc.order_no = ot.`order_no`
          LEFT JOIN warehouse_info wi
            ON ot.warehouse_info_id = wi.`id`
		  left join driver_info di on di.id = osc.driver_info_id
		  left join vehicle_info vi on vi.id = osc.vehicle_id
		  LEFT JOIN supplier_info si ON si.`id` = vi.supplier_id
          where ot.`main_order_no` = #{mainOrderNo}
    </select>
    <!--    <select id="findTransportOrderByPage" parameterType="com.jayud.tms.model.bo.QueryOrderTmsForm"-->
    <!--            resultType="com.jayud.tms.model.vo.OrderTransportVO">-->
    <!--        SELECT-->
    <!--        ot.`id`,-->
    <!--        oi.`id` mainOrderId,-->
    <!--        oi.`order_no` mainOrderNo,-->
    <!--        oi.`biz_code` bizCode,-->
    <!--        ot.`order_no` orderNo,-->
    <!--        p.`name` portName,-->
    <!--        ot.`goods_type` goodsType,-->
    <!--        oi.`status`,-->
    <!--        oi.`class_code` classCode,-->
    <!--        pc.`name` classCodeDesc,-->
    <!--        oi.`customer_name` customerName,-->
    <!--        oi.`customer_code` customerCode,-->
    <!--        ot.`created_user` createdUser,-->
    <!--        DATE_FORMAT(ot.`created_time`,'%Y-%m-%d %H:%i:%S') createdTimeStr,-->
    <!--        (SELECT ota.`goods_desc` FROM order_take_adr ota LEFT JOIN delivery_address da ON ota.`delivery_id` = da.`id`-->
    <!--        where ota.order_no = ot.order_no AND ota.`opr_type` = '1' limit 1-->
    <!--        ) goodsDesc,-->
    <!--        (SELECT ota.`piece_amount` FROM order_take_adr ota LEFT JOIN delivery_address da ON ota.`delivery_id` = da.`id`-->
    <!--        where ota.order_no = ot.order_no AND ota.`opr_type` = '1' limit 1-->
    <!--        ) pieceAmount,-->
    <!--        (SELECT ota.`plate_amount` FROM order_take_adr ota LEFT JOIN delivery_address da ON ota.`delivery_id` = da.`id`-->
    <!--        where ota.order_no = ot.order_no AND ota.`opr_type` = '1' limit 1-->
    <!--        ) plateAmount,-->
    <!--        (SELECT ota.`weight` FROM order_take_adr ota LEFT JOIN delivery_address da ON ota.`delivery_id` = da.`id` where-->
    <!--        ota.order_no = ot.order_no AND ota.`opr_type` = '1' limit 1-->
    <!--        ) weight,-->
    <!--        (SELECT SUM(ota.`weight`) FROM order_take_adr ota LEFT JOIN delivery_address da ON ota.`delivery_id` = da.`id`-->
    <!--        where ota.order_no = ot.order_no AND ota.`opr_type` = '1'-->
    <!--        ) totalWeight,-->
    <!--        (SELECT da.`state_name` FROM order_take_adr ota LEFT JOIN delivery_address da ON ota.`delivery_id` = da.`id`-->
    <!--        where ota.order_no = ot.order_no AND ota.`opr_type` = '1' limit 1-->
    <!--        ) stateName1,-->
    <!--        (SELECT da.`city_name` FROM order_take_adr ota LEFT JOIN delivery_address da ON ota.`delivery_id` = da.`id`-->
    <!--        where ota.order_no = ot.order_no AND ota.`opr_type` = '1' limit 1-->
    <!--        ) cityName1,-->
    <!--        (SELECT da.`address` FROM order_take_adr ota LEFT JOIN delivery_address da ON ota.`delivery_id` = da.`id` where-->
    <!--        ota.order_no = ot.order_no AND ota.`opr_type` = '1' limit 1-->
    <!--        ) address1,-->
    <!--        (SELECT da.`state_name` FROM order_take_adr ota LEFT JOIN delivery_address da ON ota.`delivery_id` = da.`id`-->
    <!--        where ota.order_no = ot.order_no AND ota.`opr_type` = '2' limit 1-->
    <!--        ) stateName2,-->
    <!--        (SELECT da.`city_name` FROM order_take_adr ota LEFT JOIN delivery_address da ON ota.`delivery_id` = da.`id`-->
    <!--        where ota.order_no = ot.order_no AND ota.`opr_type` = '2' limit 1-->
    <!--        ) cityName2,-->
    <!--        (SELECT da.`address` FROM order_take_adr ota LEFT JOIN delivery_address da ON ota.`delivery_id` = da.`id` where-->
    <!--        ota.order_no = ot.order_no AND ota.`opr_type` = '2' limit 1-->
    <!--        ) address2,-->
    <!--        ot.`vehicle_type` vehicleType,-->
    <!--        ot.`vehicle_size` vehicleSize,-->
    <!--        ot.`cntr_no` cntrNo,-->
    <!--        (CASE WHEN (SELECT COUNT(1) FROM order_payment_cost opc WHERE opc.main_order_no = oi.`order_no`) +-->
    <!--        (SELECT COUNT(1) FROM order_receivable_cost orc WHERE orc.main_order_no = oi.`order_no`)>0 THEN TRUE-->
    <!--        ELSE FALSE-->
    <!--        END) isCost,-->
    <!--        oi.`need_input_cost` needInputCost,-->
    <!--        ot.`status` subTmsStatus,-->
    <!--        oi.legal_name legalName,-->
    <!--        oi.unit_code unitCode,-->
    <!--        ot.`legal_name` subLegalName,-->
    <!--        ot.unit_code subUnitCode,-->
    <!--        (SELECT GROUP_CONCAT(ota.take_time) FROM order_take_adr ota LEFT JOIN delivery_address da ON ota.`delivery_id` =-->
    <!--        da.`id` where ota.order_no = ot.order_no AND ota.`opr_type` = '1' group by ot.order_no-->
    <!--        ) takeTimeStr,-->
    <!--        (SELECT GROUP_CONCAT(ota.file) FROM order_take_adr ota LEFT JOIN delivery_address da ON ota.`delivery_id` =-->
    <!--        da.`id` where ota.order_no = ot.order_no AND ota.`opr_type` = '1' group by ot.order_no-->
    <!--        ) file1,-->
    <!--        (SELECT GROUP_CONCAT(ota.file_name) FROM order_take_adr ota LEFT JOIN delivery_address da ON ota.`delivery_id` =-->
    <!--        da.`id` where ota.order_no = ot.order_no AND ota.`opr_type` = '1' group by ot.order_no-->
    <!--        ) fileName1,-->
    <!--        (SELECT GROUP_CONCAT(ota.file) FROM order_take_adr ota LEFT JOIN delivery_address da ON ota.`delivery_id` =-->
    <!--        da.`id` where ota.order_no = ot.order_no AND ota.`opr_type` = '2' group by ot.order_no-->
    <!--        ) file2,-->
    <!--        (SELECT GROUP_CONCAT(ota.file_name) FROM order_take_adr ota LEFT JOIN delivery_address da ON ota.`delivery_id` =-->
    <!--        da.`id` where ota.order_no = ot.order_no AND ota.`opr_type` = '2' group by ot.order_no-->
    <!--        ) fileName2,-->
    <!--        oi.selected_server selectedServer,-->
    <!--        ot.car_weigh_num carWeighNum-->
    <!--        FROM-->
    <!--        order_transport ot-->
    <!--        LEFT JOIN order_info oi-->
    <!--        ON ot.`main_order_no` = oi.`order_no`-->
    <!--        LEFT JOIN port_info p-->
    <!--        ON p.`id_code` = ot.`port_code`-->
    <!--        LEFT JOIN product_classify pc-->
    <!--        ON oi.`class_code` = pc.`id_code`-->
    <!--        where 1 = 1-->
    <!--        <if test="form.orderNo != null and form.orderNo != ''">-->
    <!--            and ot.order_no = #{form.orderNo}-->
    <!--        </if>-->
    <!--        <if test="form.portCode != null and form.portCode != ''">-->
    <!--            and ot.port_code = #{form.portCode}-->
    <!--        </if>-->
    <!--        <if test="form.classCode != null and form.classCode !=''">-->
    <!--            and oi.class_code = #{form.classCode}-->
    <!--        </if>-->
    <!--        <if test="form.customerName != null and form.customerName !=''">-->
    <!--            and oi.customer_name like concat('%',#{form.customerName},'%')-->
    <!--        </if>-->
    <!--        <if test="form.legalName != null and form.legalName !=''">-->
    <!--            and ot.legal_name like concat('%',#{form.legalName},'%')-->
    <!--        </if>-->
    <!--        <if test="form.endCreatedTime != null and form.endCreatedTime !=''">-->
    <!--            and DATE_FORMAT(ot.`created_time`,'%Y-%m-%d %H:%i:%S') <![CDATA[<=]]> #{form.endCreatedTime}-->
    <!--        </if>-->
    <!--        <if test="form.beginCreatedTime != null and form.beginCreatedTime !=''">-->
    <!--            and DATE_FORMAT(ot.`created_time`,'%Y-%m-%d %H:%i:%S') <![CDATA[>=]]> #{form.beginCreatedTime}-->
    <!--        </if>-->
    <!--        <if test="form.cmd == 'T_1'">-->
    <!--            AND ot.`status` = 'T_0' AND oi.`status` in ('1','4')-->
    <!--        </if>-->
    <!--        <if test="form.cmd == 'T_2'">-->
    <!--            AND ot.`status` = 'T_1'-->
    <!--        </if>-->
    <!--        <if test="form.cmd == 'T_3'">-->
    <!--            and ot.`status` = 'T_2'-->
    <!--        </if>-->
    <!--        <if test="form.cmd == 'T_3_1'">-->
    <!--            AND ot.`status` = 'T_3_1'-->
    <!--        </if>-->
    <!--        <if test="form.cmd == 'T_4'">-->
    <!--            AND ot.`status` = 'T_3'-->
    <!--        </if>-->
    <!--        <if test="form.cmd == 'T_5'">-->
    <!--            AND ot.`status` = 'T_4'-->
    <!--        </if>-->
    <!--        <if test="form.cmd == 'T_6'">-->
    <!--            AND ot.`status` = 'T_5' and ot.is_vehicle_weigh = '1'-->
    <!--        </if>-->
    <!--        <if test="form.cmd == 'T_8'">-->
    <!--            AND ot.`status` = 'T_7'-->
    <!--        </if>-->
    <!--        <if test="form.cmd == 'T_9'">-->
    <!--            AND ot.`status` in ('T_8','T_9_1','T_9_2')-->
    <!--        </if>-->
    <!--        <if test="form.cmd == 'clearCustoms'">-->
    <!--            AND ot.`is_hk_clear` = '1' and ot.clear_customs_no is null-->
    <!--            AND oi.`status` in ('1','4')-->
    <!--        </if>-->
    <!--        <if test="form.cmd == 'T_10'">-->
    <!--            AND ot.`status` = 'T_9'-->
    <!--        </if>-->
    <!--        <if test="form.cmd == 'T_13'">-->
    <!--            AND ot.`status` = 'T_10'-->
    <!--        </if>-->
    <!--        <if test="form.cmd == 'T_14'">-->
    <!--            AND ot.`status` = 'T_13'-->
    <!--        </if>-->
    <!--        <if test="form.cmd == 'T_15'">-->
    <!--            AND ot.`status` = 'T_14'-->
    <!--        </if>-->
    <!--        <if test="form.cmd != 'list'">-->
    <!--            AND (oi.`status`= 1 or oi.`status`=4)-->
    <!--        </if>-->
    <!--        <if test="form.cmd == 'costAudit'">-->
    <!--            and oi.`status` IN (1,4)-->
    <!--            AND (EXISTS (SELECT 1 FROM order_payment_cost opc WHERE opc.`main_order_no` = oi.order_no AND opc.`status` =-->
    <!--            '2' and opc.sub_type = 'zgys')-->
    <!--            OR EXISTS (SELECT 1 FROM order_receivable_cost orc WHERE orc.`main_order_no` = oi.order_no AND orc.`status`-->
    <!--            = '2' and orc.sub_type = 'zgys'))-->
    <!--        </if>-->
    <!--    </select>-->

    <select id="getDriverOrderTransport" parameterType="com.jayud.tms.model.bo.QueryDriverOrderTransportForm"
            resultType="com.jayud.tms.model.vo.DriverOrderTransportVO">
        select
        ot.id,ot.order_no orderNo,pf.name portName,ot.status,
        ot.created_time time,
        (select name from region_city where id=w.state_code) receivingProvince,
        (select name from region_city where id=w.city_code) receivingCity,
        (select name from region_city where id=w.area_code) receivingArea,
        w.address,w.contacts,w.contact_number contactNumber,w.is_virtual
        from
        order_send_cars oc left join order_transport ot on oc.order_no =ot.order_no
        left join port_info pf on pf.id_code = ot.port_code
        left join warehouse_info w on ot.warehouse_info_id= w.id
        <where>
            <if test="form.status !=null and form.status !=''">
                and ot.status = #{form.status}
            </if>
            <if test="form.orderNo !=null and form.orderNo !=''">
                and ot.order_no like concat('%',#{form.orderNo},'%')
            </if>
            <if test="form.driverId !=null">
                and (oc.driver_info_id = #{form.driverId} or oc.jockey_id = #{form.driverId})
            </if>
            <if test="form.orderIds !=null">
                and ot.id in
                <foreach collection="form.orderIds" index="index" item="item" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            <if test="form.excludeOrderIds !=null and form.status !=null and form.status!=''">
                and ot.id not in
                <foreach collection="form.excludeOrderIds" index="index" item="item" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            and ot.status in
            <foreach collection="status" index="index" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </where>
        order by id desc
    </select>
    <select id="statisticsDataNumber" resultType="com.jayud.tms.model.vo.StatisticsDataNumberVO">
        select
            (SELECT  count(1)  FROM order_transport ot LEFT JOIN order_info oi ON ot.`main_order_no` = oi.`order_no` LEFT JOIN port_info p ON p.`id_code` = ot.`port_code` LEFT JOIN product_classify pc ON oi.`class_code` = pc.`id_code` where ot.`status` = 'T_0' AND oi.`status` in ('1','4')) ysjd,
            (SELECT  count(1)  FROM order_transport ot LEFT JOIN order_info oi ON ot.`main_order_no` = oi.`order_no` LEFT JOIN port_info p ON p.`id_code` = ot.`port_code` LEFT JOIN product_classify pc ON oi.`class_code` = pc.`id_code` where ot.`status` = 'T_1' ) yspc,
            (SELECT  count(1)  FROM order_transport ot LEFT JOIN order_info oi ON ot.`main_order_no` = oi.`order_no` LEFT JOIN port_info p ON p.`id_code` = ot.`port_code` LEFT JOIN product_classify pc ON oi.`class_code` = pc.`id_code` where ot.`status` = 'T_2' ) yssh,
            (SELECT  count(1)  FROM order_transport ot LEFT JOIN order_info oi ON ot.`main_order_no` = oi.`order_no` LEFT JOIN port_info p ON p.`id_code` = ot.`port_code` LEFT JOIN product_classify pc ON oi.`class_code` = pc.`id_code` where ot.`status` = 'T_3_1' ) bhcxdy,
            (SELECT  count(1)  FROM order_transport ot LEFT JOIN order_info oi ON ot.`main_order_no` = oi.`order_no` LEFT JOIN port_info p ON p.`id_code` = ot.`port_code` LEFT JOIN product_classify pc ON oi.`class_code` = pc.`id_code` where ot.`status` = 'T_3' ) qrpc,
            (SELECT  count(1)  FROM order_transport ot LEFT JOIN order_info oi ON ot.`main_order_no` = oi.`order_no` LEFT JOIN port_info p ON p.`id_code` = ot.`port_code` LEFT JOIN product_classify pc ON oi.`class_code` = pc.`id_code` where ot.`status` = 'T_4' ) clth,
            (SELECT  count(1)  FROM order_transport ot LEFT JOIN order_info oi ON ot.`main_order_no` = oi.`order_no` LEFT JOIN port_info p ON p.`id_code` = ot.`port_code` LEFT JOIN product_classify pc ON oi.`class_code` = pc.`id_code` where ot.`status` = 'T_5' ) clgb,
            (SELECT  count(1)  FROM order_transport ot LEFT JOIN order_info oi ON ot.`main_order_no` = oi.`order_no` LEFT JOIN port_info p ON p.`id_code` = ot.`port_code` LEFT JOIN product_classify pc ON oi.`class_code` = pc.`id_code` where ot.`status` = 'T_7' ) tgqfh,
            (SELECT  count(1)  FROM order_transport ot LEFT JOIN order_info oi ON ot.`main_order_no` = oi.`order_no` LEFT JOIN port_info p ON p.`id_code` = ot.`port_code` LEFT JOIN product_classify pc ON oi.`class_code` = pc.`id_code` where ot.`status` in ('T_8','T_9_1','T_9_2')) cltg,
            (SELECT  count(1)  FROM order_transport ot LEFT JOIN order_info oi ON ot.`main_order_no` = oi.`order_no` LEFT JOIN port_info p ON p.`id_code` = ot.`port_code` LEFT JOIN product_classify pc ON oi.`class_code` = pc.`id_code` where ot.`is_hk_clear` = '1' and ot.clear_customs_no is null AND oi.`status` in ('1','4')) xgqg,
            (SELECT  count(1)  FROM order_transport ot LEFT JOIN order_info oi ON ot.`main_order_no` = oi.`order_no` LEFT JOIN port_info p ON p.`id_code` = ot.`port_code` LEFT JOIN product_classify pc ON oi.`class_code` = pc.`id_code` where oi.`status` = 'T_9') clrc,
            (SELECT  count(1)  FROM order_transport ot LEFT JOIN order_info oi ON ot.`main_order_no` = oi.`order_no` LEFT JOIN port_info p ON p.`id_code` = ot.`port_code` LEFT JOIN product_classify pc ON oi.`class_code` = pc.`id_code` where oi.`status` = 'T_10') clcc,
            (SELECT  count(1)  FROM order_transport ot LEFT JOIN order_info oi ON ot.`main_order_no` = oi.`order_no` LEFT JOIN port_info p ON p.`id_code` = ot.`port_code` LEFT JOIN product_classify pc ON oi.`class_code` = pc.`id_code` where oi.`status` = 'T_13') clps,
            (SELECT  count(1)  FROM order_transport ot LEFT JOIN order_info oi ON ot.`main_order_no` = oi.`order_no` LEFT JOIN port_info p ON p.`id_code` = ot.`port_code` LEFT JOIN product_classify pc ON oi.`class_code` = pc.`id_code` where oi.`status` = 'T_14') qrqs
        from
             dual
    </select>


    <select id="getOrderTransportByMainOrderNo" parameterType="list" resultMap="ResultMap">
        select
        ot.id,ot.main_order_no,ot.order_no,ot.status,
        ota.id,ota.order_no,ota.delivery_id,ota.take_time,
        ota.goods_desc,ota.plate_amount,ota.piece_amount,
        ota.weight,ota.volume,ota.remarks,ota.opr_type,ota.enter_warehouse_no
        from order_transport ot
        left join order_take_adr ota on ot.order_no=ota.order_no
        <where>
            and ot.main_order_no in
            <foreach collection="mainOrderNo" index="index" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </where>
    </select>

    <select id="findTransportOrderByPage"
            resultType="com.jayud.tms.model.vo.OrderTransportVO">
        SELECT
        ot.`id`,
        oi.`id` mainOrderId,
        oi.`order_no` mainOrderNo,
        oi.`biz_code` bizCode,
        ot.`order_no` orderNo,
        ot.port_code,
        ot.`goods_type` goodsType,
        oi.`status`,
        oi.`class_code` classCode,
        oi.`customer_name` customerName,
        oi.`customer_code` customerCode,
        oi.`remarks` mainOrderRemarks,
        ot.`created_user` createdUser,
        ot.warehouse_info_id warehouseInfoId,
        ot.`created_time` createdTimeStr,
        ot.`vehicle_type` vehicleType,
        ot.`vehicle_size` vehicleSize,
        ot.`cntr_no` cntrNo,
        oi.`need_input_cost` needInputCost,
        ot.`status` subTmsStatus,
        oi.legal_name legalName,
        oi.unit_code unitCode,
        ot.`legal_name` subLegalName,
        ot.unit_code subUnitCode,
        oi.selected_server selectedServer,
        ot.car_weigh_num carWeighNum,
        si.supplier_code defaultSupplierCode,
        si.app_key appKey,
        si.gps_address gpsAddress,
        os.vehicle_id vehicleId,
        os.driver_info_id driverInfoId,
        vi.plate_number plateNumber,
        ot.supplier_vehicle_size,
        ota.take_time takeTimeStr,
        ot.department_id
        FROM
        order_transport ot
        LEFT JOIN order_info oi
        ON ot.`main_order_no` = oi.`order_no`
        LEFT JOIN order_send_cars os ON os.order_no = ot.order_no
        LEFT JOIN vehicle_info vi ON vi.id=os.vehicle_id
        LEFT JOIN supplier_info si ON si.id=vi.supplier_id
        left join (select tmp.order_no,tmp.take_time from order_take_adr tmp where tmp.opr_type=1 group by tmp.order_no)
        ota on ota.order_no = ot.order_no
        <where>
            <if test="form.orderNo != null and form.orderNo != ''">
                and ot.order_no like concat('%',#{form.orderNo},'%')
            </if>
            <if test="form.subOrderNos != null and form.subOrderNos.size>0">
                and ot.order_no in
                <foreach collection="form.subOrderNos" item="item" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>

            <if test="form.mainOrderNo != null and form.mainOrderNo != ''">
                and ot.main_order_no like concat('%',#{form.mainOrderNo},'%')
            </if>
            <if test="form.portCode != null and form.portCode != ''">
                and ot.port_code = #{form.portCode}
            </if>
            <if test="form.classCode != null and form.classCode !=''">
                and oi.class_code = #{form.classCode}
            </if>

            <if test="form.legalName != null and form.legalName !=''">
                and ot.legal_name like concat('%',#{form.legalName},'%')
            </if>
            <if test="form.endCreatedTime != null and form.endCreatedTime !=''">
                and DATE_FORMAT(ot.`created_time`,'%Y-%m-%d %H:%i:%S') <![CDATA[<=]]> #{form.endCreatedTime}
            </if>
            <if test="form.beginCreatedTime != null and form.beginCreatedTime !=''">
                and DATE_FORMAT(ot.`created_time`,'%Y-%m-%d %H:%i:%S') <![CDATA[>=]]> #{form.beginCreatedTime}
            </if>
            <if test="form.cmd == 'T_1'">
                AND ot.`status` = 'T_0' AND oi.`status` in ('1','4')
            </if>
            <if test="form.cmd == 'T_2'">
                AND ot.`status` = 'T_1'
            </if>
            <if test="form.cmd == 'T_3'">
                and ot.`status` = 'T_2'
            </if>
            <if test="form.cmd == 'T_3_1'">
                AND ot.`status` = 'T_3_1'
            </if>
            <if test="form.cmd == 'T_4'">
                AND ot.`status` = 'T_3'
            </if>
            <if test="form.cmd == 'T_5'">
                AND ot.`status` = 'T_4'
            </if>
            <if test="form.cmd == 'T_6'">
                AND ot.`status` = 'T_5' and ot.is_vehicle_weigh = '1'
            </if>
            <if test="form.cmd == 'T_8'">
                AND ot.`status` = 'T_7'
            </if>
            <if test="form.cmd == 'T_9'">
                AND ot.`status` in ('T_8','T_9_1','T_9_2')
            </if>
            <if test="form.cmd == 'clearCustoms'">
                AND ot.`is_hk_clear` = '1' and ot.seamless_no is null
                AND oi.`status` in ('1','4')
                <if test="dataControl.accountType==1 and dataControl.companyIds != null and dataControl.companyIds.size>0">
                    and ot.`hk_legal_id` in
                    <foreach collection="dataControl.companyIds" item="legalId" open="(" separator="," close=")">
                        #{legalId}
                    </foreach>
                </if>
            </if>
            <if test="form.cmd == 'T_10'">
                AND ot.`status` = 'T_9'
            </if>
            <if test="form.cmd == 'T_13'">
                AND ot.`status` = 'T_10'
            </if>
            <if test="form.cmd == 'T_14'">
                AND ot.`status` = 'T_13'
            </if>
            <if test="form.cmd == 'T_15'">
                AND ot.`status` = 'T_14'
            </if>
            <if test="form.cmd == 'list'">
                AND (oi.`status` in (1,3,4))
            </if>

            <if test="form.subOrderIds !=null and form.subOrderIds.size>0">
                AND ot.id in
                <foreach collection="form.subOrderIds" item="item" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            <if test="form.cmd == 'costAudit'">
                and oi.`status` IN (1,3,4)
                AND (EXISTS (SELECT 1 FROM order_payment_cost opc WHERE opc.`main_order_no` = oi.order_no AND
                opc.`status` =
                '2' and opc.sub_type = 'zgys')
                OR EXISTS (SELECT 1 FROM order_receivable_cost orc WHERE orc.`main_order_no` = oi.order_no AND
                orc.`status`
                = '2' and orc.sub_type = 'zgys'))
            </if>
            <if test="form.cmd == 'costAudited'">
                and oi.`status` IN (1,3,4)
                AND ot.order_no in (
                (SELECT opc.order_no FROM order_payment_cost opc WHERE opc.`status` = '3' and opc.sub_type='zgys' and
                opc.is_bill='0'
                union SELECT orc.order_no FROM order_receivable_cost orc WHERE orc.`status` = '3' and
                orc.sub_type='zgys'
                and orc.is_bill='0')
                )
            </if>
            <if test="form.customerName != null and form.customerName !=''">
                <choose>
                    <when test="dataControl.accountType!=null and dataControl.accountType==3">
                        and ot.legal_name like concat('%',#{form.customerName},'%')
                    </when>
                    <otherwise>
                        and oi.customer_name like concat('%',#{form.customerName},'%')
                    </otherwise>
                </choose>
            </if>

            <if test="dataControl.companyIds != null and dataControl.companyIds.size>0">
                <choose>
                    <when test="dataControl.accountType!=null and dataControl.accountType==3">
                        and ot.`supplier_id` in
                    </when>
                    <otherwise>
                        and ot.`legal_entity_id` in
                    </otherwise>
                </choose>
                <foreach collection="dataControl.companyIds" item="companyId" open="(" separator="," close=")">
                    #{companyId}
                </foreach>
            </if>
            <if test="form.takeTimeStr != null and form.takeTimeStr.size>0">
                and ota.take_time between #{form.takeTimeStr[0]} and #{form.takeTimeStr[1]}
            </if>
            <if test="form.departmentId != null ">
                and ot.department_id = #{form.departmentId}
            </if>
            order by ota.take_time desc
        </where>
    </select>


    <select id="findTVShowOrderByPage"
            resultType="com.jayud.tms.model.vo.statistical.TVOrderTransportVO">
        SELECT
        ot.`id`,
        ot.`main_order_no` mainOrderNo,
        ot.`order_no` orderNo,
        ot.`status` status,
        ot.warehouse_info_id,
        os.vehicle_id vehicleId,
        os.driver_info_id driverInfoId
        FROM
        order_transport ot
        LEFT JOIN order_send_cars os
        ON os.order_no = ot.order_no
        <where>
            <if test="legalNames != null and legalNames.size>0">
                and ot.`legal_name` in
                <foreach collection="legalNames" item="item" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            and ot.status != 'T_15'
            and DATE_FORMAT( ot.created_time, '%Y%m' ) >= DATE_FORMAT( DATE_SUB( curdate(), INTERVAL 1 MONTH ), '%Y%m' )
            -- and DATE_FORMAT(ot.created_time, '%Y%m')=DATE_FORMAT('2021-3-1', '%Y%m')

        </where>
        order by id desc
    </select>


    <select id="findStatisticsSalesmanRanking"
            resultType="com.jayud.tms.model.vo.statistical.BusinessPeople">
        SELECT
        ot.created_user ,
        count(id) orderNum
        FROM
        order_transport ot
        <where>
            <if test="legalNames != null and legalNames.size>0">
                and ot.`legal_name` in
                <foreach collection="legalNames" item="item" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            -- and DATE_FORMAT( ot.created_time, '%Y%m' ) >= DATE_FORMAT( DATE_SUB( curdate(), INTERVAL 1 MONTH ),'%Y%m'
            )
            and DATE_FORMAT(ot.created_time, '%Y%m')=DATE_FORMAT(NOW(), '%Y%m')
        </where>
        GROUP BY ot.created_user
        order by orderNum desc
    </select>


    <select id="initPdfData" resultType="com.jayud.tms.model.vo.SendCarPdfVO">
        SELECT
        ot.`legal_name` legalName,
        '' enLegalName,
        '' tel,
        '' fax,
        ot.`order_no` orderNo,
        DATE_FORMAT(
        ot.`jiedan_time`,
        '%Y-%m-%d %H:%i:%S'
        ) jiedanTimeStr,
        vi.plate_number licensePlate,
        vi.hk_number hkLicensePlate,
        di.phone driverPhone,
        ifnull(osc.`vehicle_size`,ot.vehicle_size) vehicleSize,
        ifnull(osc.`vehicle_type`,ot.vehicle_type) vehicleType,
        ifnull(osc.cntr_no,ot.cntr_no) cntrNo,
        p.`name` portName,
        ot.`goods_type` goodsType,
        '' jiedanUser,
        si.`supplier_ch_name` clearCustomsAddress,
        ot.supplier_vehicle_size,
        (SELECT su.phone FROM `system_user` su WHERE su.name = ot.`jiedan_user`) jiedanPhone
        FROM
        order_transport ot
        LEFT JOIN order_info oi ON ot.`main_order_no` = oi.`order_no`
        LEFT JOIN order_send_cars osc ON osc.`order_no` = ot.`order_no`
        LEFT JOIN port_info p ON p.`id_code` = ot.`port_code`
        left join driver_info di on di.id = osc.driver_info_id
        left join vehicle_info vi on vi.id = osc.vehicle_id
        LEFT JOIN supplier_info si ON vi.supplier_id = si.`id`
        WHERE
        (oi.`class_code` = 'ZGYS' or oi.class_code='KY')
        <if test="orderNo != null and orderNo != ''">
            and ot.order_no = #{orderNo}
        </if>
    </select>


    <select id="getNumByStatus" resultType="java.lang.Integer">
        select count(*) from order_transport ot
        LEFT JOIN order_info oi
        ON ot.`main_order_no` = oi.`order_no`
        <where>
            <choose>
                <when test="status=='T_0'">
                    and ot.status=#{status} AND oi.`status` in ('1','4')
                </when>
                <when test="status == 'T_5'">
                    AND ot.`status` = 'T_5' and ot.is_vehicle_weigh = '1'
                </when>
                <when test="status == 'T_8'">
                    AND ot.`status` in ('T_8','T_9_1','T_9_2')
                </when>
                <when test="status == 'HK_C_1'">
                    AND ot.`is_hk_clear` = '1' and ot.seamless_no is null
                    AND oi.`status` in ('1','4')
                    <if test="dataControl.companyIds != null and dataControl.companyIds.size>0">
                        and ot.`hk_legal_id` in
                        <foreach collection="dataControl.companyIds" item="legalId" open="(" separator="," close=")">
                            #{legalId}
                        </foreach>
                    </if>
                </when>
                <otherwise>
                    and ot.status=#{status}
                </otherwise>
            </choose>


            <if test="dataControl.companyIds != null and dataControl.companyIds.size>0">
                <choose>
                    <when test="dataControl.accountType!=null and dataControl.accountType==3">
                        and ot.`supplier_id` in
                    </when>
                    <otherwise>
                        and ot.`legal_entity_id` in
                    </otherwise>
                </choose>
                <foreach collection="dataControl.companyIds" item="companyId" open="(" separator="," close=")">
                    #{companyId}
                </foreach>
            </if>

            <choose>
                <when test="status== 'T_8'">
                    group by ot.status in ('T_8','T_9_1','T_9_2')
                </when>
                <when test="status != 'HK_C_1'">
                    group by ot.status
                </when>
            </choose>

            <!--            <if test="legalIds != null and legalIds.size>0">-->
            <!--                and ot.`legal_entity_id` in-->
            <!--                <foreach collection="legalIds" item="legalId" open="(" separator="," close=")">-->
            <!--                    #{legalId}-->
            <!--                </foreach>-->
            <!--            </if>-->
        </where>
    </select>

    <select id="getTmsOrderInfoByMainOrderNos" resultMap="ResultOneMap">
        select
        ot.main_order_no,ot.order_no,ot.port_code,ot.goods_type,ot.vehicle_type,
        ot.vehicle_size,ot.unit_code,ot.legal_name,ot.legal_entity_id,ot.status,
        oc.id, oc.transport_no, oc.order_no,oc.vehicle_type, oc.vehicle_size, oc.cntr_no, oc.cntr_pic,
        oc.cntr_pic_name, oc.driver_info_id,
        oc.vehicle_id,oc.remarks, oc.describes, oc.status, oc.updated_time, oc.updated_user, oc.created_user,
        oc.created_time,oc.jockey_id,oc.jockey,ot.seamless_no
        from
        order_transport ot left join order_send_cars oc on ot.order_no=oc.order_no
        <where>
            and ot.main_order_no in
            <foreach collection="mainOrderNos" index="index" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </where>
    </select>

    <select id="getTmsOrderInfoById" resultMap="ResultTwoMap">
        select
        ot.id, ot.supplier_id,
        ot.main_order_no,ot.order_no,ot.port_code,
        ot.goods_type,ot.vehicle_type,
        ot.vehicle_size,ot.unit_code,ot.legal_name,ot.legal_entity_id,ot.status,ot.supplier_vehicle_size,
        oc.id sendCarId, oc.transport_no, oc.order_no,oc.vehicle_type, oc.vehicle_size, oc.cntr_no, oc.cntr_pic,
        oc.cntr_pic_name, oc.driver_info_id,
        oc.vehicle_id,oc.remarks, oc.describes, oc.status, oc.updated_time, oc.updated_user, oc.created_user,
        oc.created_time,oc.jockey_id,oc.jockey,oc.remarks
        from
        order_transport ot left join order_send_cars oc on ot.order_no=oc.order_no
        <where>
            and ot.id = #{id}
        </where>
    </select>
    <select id="findSupplierBillByPage" resultType="com.jayud.tms.model.vo.supplier.SupplierBill">
        select
        tmp.subOrderId,
        tmp.customer,
        tmp.MONTH,
        sum(tmp.orderNum) orderNum
        from (
        SELECT
        ot.id subOrderId,
        ot.legal_name customer,
        DATE_FORMAT(tmp1.take_time, '%Y-%m' ) MONTH,
        count( DISTINCT ot.id ) orderNum
        FROM
        order_transport ot
        LEFT JOIN
        (select ota1.* from order_take_adr ota1,
        (select min(ota2.id) id from order_take_adr ota2 where ota2.opr_type=1 group by ota2.order_no) ota3 where
        ota1.id=ota3.id)
        tmp1 ON ot.order_no = tmp1.order_no
        <where>
            ot.supplier_id = #{form.supplierId}
            <if test="form.customer !=null and form.customer !='' ">
                and ot.legal_name like concat('%',#{form.customer},'%')
            </if>
            <if test="form.month !=null and form.month.size >0 ">
                and DATE_FORMAT(ota.take_time,'%Y-%m') between #{form.month[0]} and #{form.month[1]}
            </if>
        </where>
        GROUP BY tmp1.order_no)
        tmp
        GROUP BY tmp.MONTH
        ORDER BY tmp.MONTH DESC
    </select>


    <select id="findSupplierBillInfoByPage" resultType="com.jayud.tms.model.vo.supplier.SupplierBillInfo">
        select
        ot.id subOrderId,
        ot.order_no,
        DATE_FORMAT(ota.take_time,'%Y-%m') takeTimeStr,
        ot.legal_name customerName,
        osc.vehicle_size,
        ot.warehouse_info_id,
        osc.vehicle_id
        from
        order_transport ot left join order_take_adr ota on ot.order_no=ota.order_no and ota.opr_type=1
        left join order_send_cars osc on osc.order_no = ota.order_no
        <where>
            ot.supplier_id = #{form.supplierId}
            <if test="form.customer !=null and form.customer !='' ">
                and ot.legal_name like concat('%',#{form.customer},'%')
            </if>
            <if test="form.month !=null and form.month !='' ">
                and DATE_FORMAT(ota.take_time,'%Y-%m') = #{form.month}
            </if>
        </where>
        group by ot.order_no
        order by ota.take_time desc
    </select>
    <select id="isVirtualWarehouseByOrderNo" resultType="java.lang.Integer">
        select count(*) from order_transport ot
        left join warehouse_info w on ot.warehouse_info_id = w.id
        <where>
            and ot.order_no=#{orderNo}
            and w.is_virtual = true
        </where>
    </select>
</mapper>
