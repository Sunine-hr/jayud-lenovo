<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jayud.trailer.mapper.TrailerOrderMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.jayud.trailer.po.TrailerOrder">
        <id column="id" property="id" />
        <result column="order_no" property="orderNo" />
        <result column="main_order_no" property="mainOrderNo" />
        <result column="status" property="status" />
        <result column="process_status" property="processStatus" />
        <result column="legal_entity_id" property="legalEntityId" />
        <result column="legal_name" property="legalName" />
        <result column="imp_and_exp_type" property="impAndExpType" />
        <result column="unit_code" property="unitCode" />
        <result column="unit_code_name" property="unitCodeName" />
        <result column="port_departure_code" property="portDepartureCode" />
        <result column="port_destination_code" property="portDestinationCode" />
        <result column="cabinet_size" property="cabinetSize" />
        <result column="bill_of_lading" property="billOfLading" />
        <result column="bol_file_path" property="bolFilePath" />
        <result column="bol_file_name" property="bolFileName" />
        <result column="paper_strip_seal" property="paperStripSeal" />
        <result column="pss_file_path" property="pssFilePath" />
        <result column="pss_file_name" property="pssFileName" />
        <result column="cabinet_number" property="cabinetNumber" />
        <result column="cn_file_path" property="cnFilePath" />
        <result column="cn_file_name" property="cnFileName" />
        <result column="so" property="so" />
        <result column="so_file_path" property="soFilePath" />
        <result column="so_file_name" property="soFileName" />
        <result column="arrival_time" property="arrivalTime" />
        <result column="closing_warehouse_time" property="closingWarehouseTime" />
        <result column="time_counter_rent" property="timeCounterRent" />
        <result column="open_time" property="openTime" />
        <result column="cutting_replenishing_time" property="cuttingReplenishingTime" />
        <result column="
closing_time" property="
closingTime" />
        <result column="
release_time" property="
releaseTime" />
        <result column="is_weighed" property="isWeighed" />
        <result column="is_make_up" property="isMakeUp" />
        <result column="create_user" property="createUser" />
        <result column="create_time" property="createTime" />
        <result column="update_user" property="updateUser" />
        <result column="update_time" property="updateTime" />
        <result column="need_input_cost" property="needInputCost" />
        <result column="order_taker" property="orderTaker" />
        <result column="receiving_orders_date" property="receivingOrdersDate" />
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id, order_no, main_order_no, status, process_status, legal_entity_id, legal_name, imp_and_exp_type, unit_code, unit_code_name, port_departure_code, port_destination_code, cabinet_size, bill_of_lading, bol_file_path, bol_file_name, paper_strip_seal, pss_file_path, pss_file_name, cabinet_number, cn_file_path, cn_file_name, so, so_file_path, so_file_name, arrival_time, closing_warehouse_time, time_counter_rent, open_time, cutting_replenishing_time, 
closing_time, 
release_time, is_weighed, is_make_up, create_user, create_time, update_user, update_time, need_input_cost, order_taker, receiving_orders_date
    </sql>

    <select id="getTrailerOrder" resultType="com.jayud.trailer.vo.TrailerOrderVO">
        select id,order_no orderNo,main_order_no mainOrderNo,status, process_status processStatus,
        legal_entity_id legalEntityId,legal_name legalName,imp_and_exp_type impAndExpType,
        unit_code unitName,unit_code_name unitCodeName,port_departure_code portDepartureCode,
        port_destination_code portDestinationCode,
        cabinet_size cabinetSize,
        bill_of_lading billOfLading,bol_file_path bolFilePath,bol_file_name bolFileName,
        paper_strip_seal paperStripSeal,
        pss_file_path pssFilePath,
        pss_file_name pssFileName,
        cabinet_number cabinetNumber,
        cn_file_path cnFilePath,
        cn_file_name cnFileName,
        so,so_file_path soFilePath,so_file_name soFileName,
        arrival_time arrivalTime,closing_warehouse_time closingWarehouseTime,
        time_counter_rent timeCounterRent,open_time openTime,cutting_replenishing_time cuttingReplenishingTime,
        closing_time closingTime,release_time releaseTime,
        is_weighed isWeighed,is_make_up isMakeUp,create_user createUser,create_time createTime,update_user updateUser,
        update_time updateTime,need_input_cost needInputCost,order_taker orderTaker,
        receiving_orders_date receivingOrdersDate
        from trailer_order
    </select>

    <select id="findByPage" resultType="com.jayud.trailer.vo.TrailerOrderFormVO">
        select tor.id,tor.order_no orderNo,main_order_no mainOrderNo,status, process_status processStatus,
        legal_entity_id legalEntityId,legal_name legalName,imp_and_exp_type impAndExpType,
        unit_code unitName,unit_code_name unitCodeName,port_departure_code portDepartureCode,
        port_destination_code portDestinationCode,
        cabinet_size cabinetSize,
        bill_of_lading billOfLading,bol_file_path bolFilePath,bol_file_name bolFileName,
        paper_strip_seal paperStripSeal,
        pss_file_path pssFilePath,
        pss_file_name pssFileName,
        cabinet_number cabinetNumber,
        cn_file_path cnFilePath,
        cn_file_name cnFileName,
        so,so_file_path soFilePath,so_file_name soFileName,
        arrival_time arrivalTime,closing_warehouse_time closingWarehouseTime,
        time_counter_rent timeCounterRent,open_time openTime,cutting_replenishing_time cuttingReplenishingTime,
        closing_time closingTime,release_time releaseTime,
        is_weighed isWeighed,is_make_up isMakeUp,create_user createUser,create_time createTime,update_user updateUser,
        update_time updateTime,need_input_cost needInputCost,order_taker orderTaker,
        receiving_orders_date receivingOrdersDate,
        (CASE WHEN (SELECT COUNT(1) FROM order_payment_cost opc WHERE opc.order_no = a.`order_no`) +
        (SELECT COUNT(1) FROM order_receivable_cost orc WHERE orc.order_no = a.`order_no`)>0 THEN TRUE
        ELSE FALSE
        END) cost,
        from trailer_order tor
        <where>
            <if test="form.orderNo !=null and form.orderNo!=''">
                and tor.order_no like concat('%',#{form.orderNo},'%')
            </if>
            <if test="form.impAndExpType !=null and form.impAndExpType!=''">
                and tor.imp_and_exp_type like concat('%',#{form.impAndExpType},'%')
            </if>
            <if test="form.so !=null and form.so!=''">
                and tor.so like concat('%',#{form.so},'%')
            </if>
            <if test="form.cabinetNumber !=null and form.cabinetNumber!=''">
                and tor.cabinet_number like concat('%',#{form.cabinetNumber},'%')
            </if>
            <if test="form.billOfLading !=null and form.billOfLading!=''">
                and tor.bill_of_lading like concat('%',#{form.billOfLading},'%')
            </if>
            <if test="form.paperStripSeal !=null and form.paperStripSeal!=''">
                and tor.paper_strip_seal like concat('%',#{form.paperStripSeal},'%')
            </if>
            <if test="form.createUser !=null and form.createUser!=''">
                and tor.create_user like concat('%',#{form.createUser},'%')
            </if>
            <if test="form.portCode !=null and form.portCode!=''">
                and tor.port_code like concat('%',#{form.portCode},'%')
            </if>
            <if test="form.cabinetSize !=null and form.cabinetSize!=''">
                and tor.cabinet_size like concat('%',#{form.cabinetSize},'%')
            </if>
            <if test="form.mainOrderNos !=null and form.mainOrderNos.size > 0">
                and tor.main_order_no IN
                <foreach collection="form.mainOrderNos" index="index" item="item" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            <if test="form.status !=null and form.status!=''">
                and tor.status = #{form.status}
            </if>
            <if test="form.processStatusList!=null and form.processStatusList.size>0">
                and tor.process_status IN
                <foreach collection="form.processStatusList" index="index" item="item" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            <if test="form.startTime !=null and form.startTime!=''">
                and tor.create_time <![CDATA[>= ]]> #{form.startTime}
            </if>
            <if test="form.endTime !=null and form.endTime!=''">
                and tor.create_time <![CDATA[<= ]]> #{form.endTime}
            </if>
            <if test="form.cmd == 'costAudit'">
                AND (EXISTS (SELECT 1 FROM order_payment_cost opc WHERE opc.`order_no` = so.order_no AND opc.`status` =
                '2' and opc.sub_type = 'tc')
                OR EXISTS (SELECT 1 FROM order_receivable_cost orc WHERE orc.`order_no` = so.order_no AND orc.`status` =
                '2' and orc.sub_type = 'tc'))
            </if>

            <if test="legalIds != null and legalIds.size>0">
                and tor.`legal_entity_id` in
                <foreach collection="legalIds" item="legalId" open="(" separator="," close=")">
                    #{legalId}
                </foreach>
            </if>

        </where>
        order by tor.id desc
    </select>

</mapper>
